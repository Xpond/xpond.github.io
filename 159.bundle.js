/*! For license information please see 159.bundle.js.LICENSE.txt */
"use strict";(self.webpackChunkbee_maze_game=self.webpackChunkbee_maze_game||[]).push([[159],{397:(e,t,n)=>{n.r(t),n.d(t,{BeeGame:()=>Ze,default:()=>Je});var i=n(437);function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}function o(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,a(i.key),i)}}function a(e){var t=function(e){if("object"!=r(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=r(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==r(t)?t:t+""}var s=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.game=t,this.overlay=null,this.loadingProgress=null,this.menuButtons=[],this.isLoading=!0,this.isMenuActive=!1,this.createOverlay()},(t=[{key:"createOverlay",value:function(){var e=this,t=document.getElementById("loading-screen");t&&(t.style.display="none"),this.overlay=document.createElement("div"),this.overlay.id="vibejam-overlay",this.overlay.style.cssText="\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background-color: #000;\n        color: white;\n        display: flex;\n        flex-direction: column;\n        justify-content: center;\n        align-items: center;\n        z-index: 2000;\n        font-family: Arial, sans-serif;\n      ";var n=document.createElement("h1");n.textContent="#vibeJam",n.style.cssText="\n        font-size: 48px;\n        color: #ffd700;\n        margin-bottom: 40px;\n        letter-spacing: 2px;\n        text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);\n      ";var i=document.createElement("h2");i.textContent="press P to pause or change sensitivity",i.style.cssText="\n        font-size: 36px;\n        color: #ffd700;\n        margin-bottom: 20px;\n      ";var r=document.createElement("div");r.className="loading-content",r.style.cssText="\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        transition: opacity 0.5s;\n      ";var o=document.createElement("p");o.textContent="Loading game...",o.style.cssText="\n        font-size: 18px;\n        margin-bottom: 10px;\n      ";var a=document.createElement("div");a.style.cssText="\n        width: 300px;\n        height: 10px;\n        background-color: #333;\n        border-radius: 5px;\n        margin: 20px 0;\n        overflow: hidden;\n      ",this.loadingProgress=document.createElement("div"),this.loadingProgress.style.cssText="\n        height: 100%;\n        width: 0%;\n        background-color: #ffd700;\n        transition: width 0.3s;\n      ",a.appendChild(this.loadingProgress),r.appendChild(o),r.appendChild(a);var s=document.createElement("div");s.className="menu-content",s.style.cssText="\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        opacity: 0;\n        transform: translateY(20px);\n        transition: opacity 0.5s, transform 0.5s;\n        pointer-events: none;\n      ";var l=document.createElement("p");l.textContent="play until you win",l.style.cssText="\n        font-size: 18px;\n        margin-bottom: 30px;\n        max-width: 600px;\n        text-align: center;\n      ",s.appendChild(l);var c=this.createButton("Start Game",(function(){e.game.startGame(),e.hideOverlay()}));s.appendChild(c),this.menuButtons.push(c);var h=this.createButton("Controls",(function(){e.game.ui&&"function"==typeof e.game.ui.toggleControlsHelp&&e.game.ui.toggleControlsHelp()}));s.appendChild(h),this.menuButtons.push(h);var u=document.createElement("div");u.style.cssText="\n        position: absolute;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        overflow: hidden;\n        z-index: -1;\n      ";for(var m=0;m<20;m++){var p=document.createElement("div"),d=50+100*Math.random(),y=100*Math.random(),f=100*Math.random(),v=5*Math.random(),g=5+10*Math.random();p.style.cssText="\n          position: absolute;\n          width: ".concat(d,"px;\n          height: ").concat(d,"px;\n          left: ").concat(y,"vw;\n          top: ").concat(f,"vh;\n          background-color: rgba(255, 215, 0, 0.1);\n          clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);\n          animation: float").concat(m," ").concat(g,"s ease-in-out ").concat(v,"s infinite alternate;\n        ");var b=document.createElement("style");b.textContent="\n          @keyframes float".concat(m," {\n            0% { transform: translateY(0) rotate(0deg); opacity: 0.1; }\n            100% { transform: translateY(-").concat(20+30*Math.random(),"px) rotate(").concat(20*Math.random(),"deg); opacity: 0.2; }\n          }\n        "),document.head.appendChild(b),u.appendChild(p)}this.overlay.appendChild(u),this.overlay.appendChild(n),this.overlay.appendChild(i),this.overlay.appendChild(r),this.overlay.appendChild(s),document.body.appendChild(this.overlay),this.loadingContainer=r,this.menuContainer=s}},{key:"createButton",value:function(e,t){var n=document.createElement("button");return n.textContent=e,n.className="menu-button",n.style.cssText="\n        padding: 12px 24px;\n        margin: 10px 0;\n        font-size: 18px;\n        background-color: #ffc107;\n        color: #333;\n        border: none;\n        border-radius: 5px;\n        cursor: pointer;\n        transition: background-color 0.2s;\n        min-width: 180px;\n      ",n.addEventListener("mouseover",(function(){n.style.backgroundColor="#ffda44"})),n.addEventListener("mouseout",(function(){n.style.backgroundColor="#ffc107"})),n.addEventListener("click",t),n}},{key:"updateProgress",value:function(e){var t=this;this.loadingProgress&&(this.loadingProgress.style.width="".concat(e,"%")),e>=100&&this.isLoading&&(this.isLoading=!1,setTimeout((function(){return t.showMenu()}),500))}},{key:"showMenu",value:function(){this.isMenuActive||(this.isMenuActive=!0,this.loadingContainer&&(this.loadingContainer.style.opacity="0",this.loadingContainer.style.pointerEvents="none"),this.menuContainer&&(this.menuContainer.style.opacity="1",this.menuContainer.style.transform="translateY(0)",this.menuContainer.style.pointerEvents="auto"))}},{key:"hideOverlay",value:function(){var e=this;this.overlay&&(this.overlay.style.transition="opacity 0.5s",this.overlay.style.opacity="0",setTimeout((function(){e.overlay&&e.overlay.parentNode&&(e.overlay.parentNode.removeChild(e.overlay),e.overlay=null)}),500))}}])&&o(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}(),l=n(92);function c(e){return c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},c(e)}function h(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var i,r,o,a,s=[],l=!0,c=!1;try{if(o=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;l=!1}else for(;!(l=(i=o.call(n)).done)&&(s.push(i.value),s.length!==t);l=!0);}catch(e){c=!0,r=e}finally{try{if(!l&&null!=n.return&&(a=n.return(),Object(a)!==a))return}finally{if(c)throw r}}return s}}(e,t)||function(e,t){if(e){if("string"==typeof e)return u(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?u(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function u(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function m(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,p(i.key),i)}}function p(e){var t=function(e){if("object"!=c(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=c(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==c(t)?t:t+""}var d=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.game=t,this.models={},this.textures={},this.sounds={},this.animations={},this.totalAssets=0,this.loadedAssets=0,this.loadingErrors=0,this.gltfLoader=new l.B,this.textureLoader=new i.Tap,this.audioLoader=new i.Am1,this.onProgressCallback=null,this.loadingQueue=[],this.isProcessingQueue=!1,this.assetPaths={models:{bee:"assets/models/bee.glb",ant:"assets/models/ant_enemy.glb"},textures:{spaceSkybox:"assets/textures/dark_forest_high.png"},sounds:{}}},t=[{key:"init",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return this.onProgressCallback=e,this.totalAssets=Object.keys(this.assetPaths.models).length+Object.keys(this.assetPaths.textures).length+Object.keys(this.assetPaths.sounds).length,this.loadedAssets=0,this.loadingErrors=0,this.queueModelLoads(),this.queueTextureLoads(),this.processQueue()}},{key:"queueModelLoads",value:function(){for(var e=this,t=this.assetPaths.models,n=function(){var t=h(r[i],2),n=t[0],o=t[1];e.loadingQueue.push((function(){return e.loadModel(n,o)}))},i=0,r=Object.entries(t);i<r.length;i++)n()}},{key:"queueTextureLoads",value:function(){for(var e=this,t=this.assetPaths.textures,n=function(){var t=h(r[i],2),n=t[0],o=t[1];e.loadingQueue.push((function(){return e.loadTexture(n,o)}))},i=0,r=Object.entries(t);i<r.length;i++)n()}},{key:"processQueue",value:function(){var e=this;return this.isProcessingQueue?Promise.resolve():(this.isProcessingQueue=!0,new Promise((function(t){var n=function(){if(0===e.loadingQueue.length)return e.isProcessingQueue=!1,void t();e.loadingQueue.shift()().catch((function(t){console.error("Error loading asset:",t),e.loadingErrors++,e.updateProgress()})).finally((function(){setTimeout(n,10)}))};n()})))}},{key:"loadModel",value:function(e,t){var n=this;return new Promise((function(i,r){n.gltfLoader.load(t,(function(t){n.models[e]={scene:t.scene,animations:t.animations},t.animations&&t.animations.length>0&&(n.animations[e]=t.animations),t.scene.traverse((function(e){e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0)})),n.loadedAssets++,n.updateProgress(),i(t)}),(function(e){}),(function(t){console.error("Error loading model ".concat(e,":"),t),n.createFallbackModel(e),r(t)}))}))}},{key:"loadTexture",value:function(e,t){var n=this;return new Promise((function(r,o){n.textureLoader.load(t,(function(t){t.colorSpace=i.er$,e.includes("Skybox")&&(t.mapping=i.wfO),n.textures[e]=t,n.loadedAssets++,n.updateProgress(),r(t)}),void 0,(function(t){console.error("Error loading texture ".concat(e,":"),t),n.createFallbackTexture(e),o(t)}))}))}},{key:"createFallbackModel",value:function(e){var t,n;if("bee"===e){var r=new i.YJl;t=new i.Gu$(1,16,16),n=new i.tXL({color:16763904});var o=new i.eaF(t,n);o.scale.set(1,.8,1.2),r.add(o);var a=new i.tcD(.5,16),s=new i.tXL({color:16777215,transparent:!0,opacity:.4,side:i.$EB}),l=new i.eaF(a,s);l.position.set(-.5,.2,.5),l.rotation.z=Math.PI/6,l.rotation.y=Math.PI/8,l.scale.set(.5,.5,.5),l.name="leftWing",r.add(l);var c=new i.eaF(a,s);c.position.set(.5,.2,.5),c.rotation.z=-Math.PI/6,c.rotation.y=-Math.PI/8,c.scale.set(.5,.5,.5),c.name="rightWing",r.add(c),this.models[e]={scene:r,animations:[]}}else if("ant"===e){var h=new i.YJl;n=new i.tXL({color:16724736}),t=new i.Gu$(.5,16,16);var u=new i.eaF(t,n);u.position.set(0,0,.8),h.add(u),t=new i.Gu$(.4,16,16);var m=new i.eaF(t,n);m.position.set(0,0,0),h.add(m),t=new i.Gu$(.7,16,16);var p=new i.eaF(t,n);p.position.set(0,0,-.9),h.add(p),t=new i.Ho_(.05,.05,1,8);for(var d=0;d<6;d++){var y=new i.eaF(t,n),f=d%2==0?1:-1,v=Math.floor(d/2)-1;y.position.set(.5*f,0,.5*v),y.rotation.z=f*Math.PI/4,y.rotation.y=.3*v,h.add(y)}this.models[e]={scene:h,animations:[]}}else{t=new i.iNn(1,1,1),n=new i.qBx;var g=new i.eaF(t,n),b=new i.YJl;b.add(g),this.models[e]={scene:b,animations:[]}}this.loadedAssets++,this.updateProgress()}},{key:"createFallbackTexture",value:function(e){var t=document.createElement("canvas");t.width=512,t.height=512;var n=t.getContext("2d");if("honeycomb"===e){n.fillStyle="#FFCC66",n.fillRect(0,0,t.width,t.height),n.fillStyle="#FF8800";for(var r=0;r<t.height;r+=75)for(var o=0;o<t.width;o+=86.5){var a=Math.floor(r/75)%2*50*.865;n.beginPath();for(var s=0;s<6;s++){var l=Math.PI/3*s,c=o+a+50*Math.cos(l),h=r+50*Math.sin(l);0===s?n.moveTo(c,h):n.lineTo(c,h)}n.closePath(),n.fill()}}else if(e.includes("Skybox")){var u=n.createLinearGradient(0,0,0,t.height);if("forestSkybox"===e?(u.addColorStop(0,"#87CEEB"),u.addColorStop(1,"#E0F7FA")):(u.addColorStop(0,"#000000"),u.addColorStop(.5,"#0B3D91"),u.addColorStop(1,"#111111")),n.fillStyle=u,n.fillRect(0,0,t.width,t.height),"spaceSkybox"===e){n.fillStyle="#FFFFFF";for(var m=0;m<100;m++){var p=Math.random()*t.width,d=Math.random()*t.height,y=2*Math.random();n.beginPath(),n.arc(p,d,y,0,2*Math.PI),n.fill()}}}else for(var f=64,v=0;v<t.height;v+=f)for(var g=0;g<t.width;g+=f){var b=(g/f+v/f)%2==0;n.fillStyle=b?"#A5A5A5":"#FFFFFF",n.fillRect(g,v,f,f)}var w=new i.GOR(t);w.colorSpace=i.er$,e.includes("Skybox")&&(w.mapping=i.wfO),this.textures[e]=w,this.loadedAssets++,this.updateProgress()}},{key:"getModel",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return this.models[e]?t?this.models[e].scene.clone():this.models[e].scene:(console.warn("Model '".concat(e,"' not found in AssetManager")),null)}},{key:"getAnimations",value:function(e){return this.animations[e]||null}},{key:"getTexture",value:function(e){return this.textures[e]?this.textures[e]:null}},{key:"updateProgress",value:function(){var e=this.totalAssets>0?this.loadedAssets/this.totalAssets*100:100;this.onProgressCallback&&this.onProgressCallback({loaded:this.loadedAssets,total:this.totalAssets,progress:e,errors:this.loadingErrors})}},{key:"getProgress",value:function(){return{loaded:this.loadedAssets,total:this.totalAssets,progress:this.totalAssets>0?this.loadedAssets/this.totalAssets*100:100,errors:this.loadingErrors,isComplete:this.loadedAssets>=this.totalAssets}}},{key:"isLoaded",value:function(){return this.loadedAssets>=this.totalAssets}},{key:"handleVisibilityChange",value:function(){document.hidden}},{key:"dispose",value:function(){var e=this;Object.values(this.models).forEach((function(t){t.scene&&t.scene.traverse((function(t){t.isMesh&&(t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach((function(t){return e.disposeMaterial(t)})):e.disposeMaterial(t.material)))}))})),Object.values(this.textures).forEach((function(e){e&&"function"==typeof e.dispose&&e.dispose()})),this.models={},this.textures={},this.animations={},this.totalAssets=0,this.loadedAssets=0,this.loadingErrors=0}},{key:"disposeMaterial",value:function(e){e&&(Object.values(e).forEach((function(e){e&&e.isTexture&&e.dispose()})),e.dispose())}}],t&&m(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}();function y(e){return y="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},y(e)}function f(){f=function(){return t};var e,t={},n=Object.prototype,i=n.hasOwnProperty,r=Object.defineProperty||function(e,t,n){e[t]=n.value},o="function"==typeof Symbol?Symbol:{},a=o.iterator||"@@iterator",s=o.asyncIterator||"@@asyncIterator",l=o.toStringTag||"@@toStringTag";function c(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(e){c=function(e,t,n){return e[t]=n}}function h(e,t,n,i){var o=t&&t.prototype instanceof b?t:b,a=Object.create(o.prototype),s=new z(i||[]);return r(a,"_invoke",{value:T(e,n,s)}),a}function u(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=h;var m="suspendedStart",p="suspendedYield",d="executing",v="completed",g={};function b(){}function w(){}function x(){}var S={};c(S,a,(function(){return this}));var k=Object.getPrototypeOf,P=k&&k(k(I([])));P&&P!==n&&i.call(P,a)&&(S=P);var M=x.prototype=b.prototype=Object.create(S);function C(e){["next","throw","return"].forEach((function(t){c(e,t,(function(e){return this._invoke(t,e)}))}))}function E(e,t){function n(r,o,a,s){var l=u(e[r],e,o);if("throw"!==l.type){var c=l.arg,h=c.value;return h&&"object"==y(h)&&i.call(h,"__await")?t.resolve(h.__await).then((function(e){n("next",e,a,s)}),(function(e){n("throw",e,a,s)})):t.resolve(h).then((function(e){c.value=e,a(c)}),(function(e){return n("throw",e,a,s)}))}s(l.arg)}var o;r(this,"_invoke",{value:function(e,i){function r(){return new t((function(t,r){n(e,i,t,r)}))}return o=o?o.then(r,r):r()}})}function T(t,n,i){var r=m;return function(o,a){if(r===d)throw Error("Generator is already running");if(r===v){if("throw"===o)throw a;return{value:e,done:!0}}for(i.method=o,i.arg=a;;){var s=i.delegate;if(s){var l=A(s,i);if(l){if(l===g)continue;return l}}if("next"===i.method)i.sent=i._sent=i.arg;else if("throw"===i.method){if(r===m)throw r=v,i.arg;i.dispatchException(i.arg)}else"return"===i.method&&i.abrupt("return",i.arg);r=d;var c=u(t,n,i);if("normal"===c.type){if(r=i.done?v:p,c.arg===g)continue;return{value:c.arg,done:i.done}}"throw"===c.type&&(r=v,i.method="throw",i.arg=c.arg)}}}function A(t,n){var i=n.method,r=t.iterator[i];if(r===e)return n.delegate=null,"throw"===i&&t.iterator.return&&(n.method="return",n.arg=e,A(t,n),"throw"===n.method)||"return"!==i&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+i+"' method")),g;var o=u(r,t.iterator,n.arg);if("throw"===o.type)return n.method="throw",n.arg=o.arg,n.delegate=null,g;var a=o.arg;return a?a.done?(n[t.resultName]=a.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,g):a:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,g)}function B(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function L(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function z(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(B,this),this.reset(!0)}function I(t){if(t||""===t){var n=t[a];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var r=-1,o=function n(){for(;++r<t.length;)if(i.call(t,r))return n.value=t[r],n.done=!1,n;return n.value=e,n.done=!0,n};return o.next=o}}throw new TypeError(y(t)+" is not iterable")}return w.prototype=x,r(M,"constructor",{value:x,configurable:!0}),r(x,"constructor",{value:w,configurable:!0}),w.displayName=c(x,l,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===w||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,x):(e.__proto__=x,c(e,l,"GeneratorFunction")),e.prototype=Object.create(M),e},t.awrap=function(e){return{__await:e}},C(E.prototype),c(E.prototype,s,(function(){return this})),t.AsyncIterator=E,t.async=function(e,n,i,r,o){void 0===o&&(o=Promise);var a=new E(h(e,n,i,r),o);return t.isGeneratorFunction(n)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},C(M),c(M,l,"Generator"),c(M,a,(function(){return this})),c(M,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var i in t)n.push(i);return n.reverse(),function e(){for(;n.length;){var i=n.pop();if(i in t)return e.value=i,e.done=!1,e}return e.done=!0,e}},t.values=I,z.prototype={constructor:z,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(L),!t)for(var n in this)"t"===n.charAt(0)&&i.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function r(i,r){return s.type="throw",s.arg=t,n.next=i,r&&(n.method="next",n.arg=e),!!r}for(var o=this.tryEntries.length-1;o>=0;--o){var a=this.tryEntries[o],s=a.completion;if("root"===a.tryLoc)return r("end");if(a.tryLoc<=this.prev){var l=i.call(a,"catchLoc"),c=i.call(a,"finallyLoc");if(l&&c){if(this.prev<a.catchLoc)return r(a.catchLoc,!0);if(this.prev<a.finallyLoc)return r(a.finallyLoc)}else if(l){if(this.prev<a.catchLoc)return r(a.catchLoc,!0)}else{if(!c)throw Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return r(a.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc<=this.prev&&i.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var o=r;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var a=o?o.completion:{};return a.type=e,a.arg=t,o?(this.method="next",this.next=o.finallyLoc,g):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),g},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),L(n),g}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var i=n.completion;if("throw"===i.type){var r=i.arg;L(n)}return r}}throw Error("illegal catch attempt")},delegateYield:function(t,n,i){return this.delegate={iterator:I(t),resultName:n,nextLoc:i},"next"===this.method&&(this.arg=e),g}},t}function v(e,t,n,i,r,o,a){try{var s=e[o](a),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(i,r)}function g(e){return function(){var t=this,n=arguments;return new Promise((function(i,r){var o=e.apply(t,n);function a(e){v(o,i,r,a,s,"next",e)}function s(e){v(o,i,r,a,s,"throw",e)}a(void 0)}))}}function b(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,w(i.key),i)}}function w(e){var t=function(e){if("object"!=y(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=y(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==y(t)?t:t+""}var x=function(){return e=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e);try{this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.buffers=new Map,this.currentMusicSource=null,this.isMuted=!1,this.volume=.2,this.masterGain=this.audioContext.createGain(),this.masterGain.gain.setValueAtTime(this.volume,this.audioContext.currentTime),this.masterGain.connect(this.audioContext.destination)}catch(e){this.audioContext=null}},t=[{key:"resumeContext",value:function(){this.audioContext&&"suspended"===this.audioContext.state&&this.audioContext.resume().then((function(){})).catch((function(e){return console.error("Error resuming AudioContext:",e)}))}},{key:"loadSounds",value:(n=g(f().mark((function e(t){var n,i=this;return f().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.audioContext){e.next=2;break}return e.abrupt("return",Promise.resolve());case 2:return n=t.map(function(){var e=g(f().mark((function e(t){var n,r,o;return f().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,fetch(t.path);case 3:if((n=e.sent).ok){e.next=6;break}throw new Error("HTTP error! status: ".concat(n.status," for ").concat(t.path));case 6:return e.next=8,n.arrayBuffer();case 8:return r=e.sent,e.next=11,i.audioContext.decodeAudioData(r);case 11:o=e.sent,i.buffers.set(t.name,o),e.next=18;break;case 15:e.prev=15,e.t0=e.catch(0),i.buffers.set(t.name,null);case 18:case"end":return e.stop()}}),e,null,[[0,15]])})));return function(t){return e.apply(this,arguments)}}()),e.next=5,Promise.all(n);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"playSound",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;if(!this.audioContext)return null;var i=this.buffers.get(e);if(!i)return null;var r=this.audioContext.createBufferSource();r.buffer=i,r.loop=t;var o=this.audioContext.createGain();return o.gain.setValueAtTime(n,this.audioContext.currentTime),r.connect(o),o.connect(this.masterGain),r.start(0),r}},{key:"stopMusic",value:function(){if(this.currentMusicSource){try{this.currentMusicSource.stop(),this.currentMusicSource.disconnect()}catch(e){}this.currentMusicSource=null}}},{key:"playMusic",value:function(e){if(this.audioContext&&e&&0!==e.length){this.stopMusic();var t=e[Math.floor(Math.random()*e.length)];this.currentMusicSource=this.playSound(t,!0),this.currentMusicSource?this.currentMusicSource.onended=function(){}:console.error("Failed to play music track: ".concat(t))}}},{key:"setVolume",value:function(e){this.audioContext&&this.masterGain&&(this.volume=Math.max(0,Math.min(1,e)),this.isMuted||this.masterGain.gain.setValueAtTime(this.volume,this.audioContext.currentTime))}},{key:"toggleMute",value:function(){return this.audioContext&&this.masterGain?(this.isMuted=!this.isMuted,this.isMuted?this.masterGain.gain.setValueAtTime(0,this.audioContext.currentTime):this.masterGain.gain.setValueAtTime(this.volume,this.audioContext.currentTime),this.isMuted):this.isMuted}},{key:"getMuteState",value:function(){return this.isMuted}},{key:"pauseAll",value:function(){this.audioContext&&"running"===this.audioContext.state&&this.audioContext.suspend().then((function(){})).catch((function(e){return console.error("Error suspending AudioContext:",e)}))}},{key:"resumeAll",value:function(){this.audioContext&&"suspended"===this.audioContext.state&&this.audioContext.resume().then((function(){})).catch((function(e){return console.error("Error resuming AudioContext:",e)}))}}],t&&b(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,n}();function S(e){return S="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},S(e)}function k(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,P(i.key),i)}}function P(e){var t=function(e){if("object"!=S(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=S(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==S(t)?t:t+""}var M=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.game=t,this.scene=t.scene,this.treeGroup=new i.YJl,this.scene.add(this.treeGroup),this.createBackgroundPlane(),this.p5Instance=null,this.animationStarted=!1,this.transitionTriggered=!1,this.transitionProgress=0,this.autoTransitionEnabled=!0,this.initP5Animation()},(t=[{key:"createBackgroundPlane",value:function(){var e=new i.bdM(2e3,1e3);this.backgroundCanvas=document.createElement("canvas"),this.backgroundCanvas.width=1024,this.backgroundCanvas.height=512,this.backgroundTexture=new i.GOR(this.backgroundCanvas),this.backgroundTexture.minFilter=i.k6q;var t=new i.V9B({map:this.backgroundTexture,transparent:!0,side:i.$EB});this.backgroundPlane=new i.eaF(e,t),this.backgroundPlane.position.set(0,0,-500),this.treeGroup.add(this.backgroundPlane)}},{key:"initP5Animation",value:function(){var e=this,t=document.getElementById("tree-hive-container");if(t||((t=document.createElement("div")).id="tree-hive-container",t.style.position="absolute",t.style.top="0",t.style.left="0",t.style.opacity="0",t.style.pointerEvents="none",t.style.zIndex="-9999",document.body.appendChild(t)),"undefined"!=typeof p5)this.createP5Sketch(t);else{var n=document.createElement("script");n.src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js",n.onload=function(){e.createP5Sketch(t)},n.onerror=function(){console.warn("Failed to load p5.js, falling back to simple animation"),e.createFallbackAnimation()},document.head.appendChild(n)}}},{key:"createP5Sketch",value:function(e){var t=this;this.p5Instance=new p5((function(e){var n=t.backgroundCanvas,i=n.getContext("2d"),r=[],o=[],a=[],s={background:[255,248,220],honeycomb:[255,204,50],hiveOutline:[165,115,30],honeyDrop:[255,204,0],bee:[0,0,0]};e.setup=function(){e.noCanvas();for(var i=-2;i<n.height/60+2;i++)for(var s=-2;s<n.width/69.2+2;s++){var l=40*s*1.73+i%2*40*.865,c=40*i*1.5,h=.2+.8*Math.random();r.push({x:l,y:c,size:40*h,z:h,honey:Math.random()>.3,honeyLevel:.1+.7*Math.random(),pulse:Math.random()*Math.PI*2})}for(var u=0;u<10;u++)t.addHoneyDrop(o,n);for(var m=0;m<8;m++)a.push({x:Math.random()*n.width,y:Math.random()*n.height,size:5+5*Math.random(),speedX:2*(Math.random()-.5),speedY:2*(Math.random()-.5),wingPhase:Math.random()*Math.PI*2,wingSpeed:.2+.2*Math.random()});t.animationStarted=!0},e.draw=function(){if(t.animationStarted){i.fillStyle="rgb(".concat(s.background.join(","),")"),i.fillRect(0,0,n.width,n.height),i.fillStyle="rgb(".concat(s.hiveOutline.join(","),")"),i.beginPath(),i.ellipse(n.width/2,n.height+100,n.width/1.5,200,0,Math.PI,!1),i.fill();var l=n.width/2,c=n.height/2,h=i.createRadialGradient(l,c,40,l,c,160);h.addColorStop(0,"rgba(255, 204, 50, 0.6)"),h.addColorStop(1,"rgba(255, 204, 50, 0)"),i.fillStyle=h,i.beginPath(),i.arc(l,c,160,0,2*Math.PI),i.fill(),i.fillStyle="rgba(40, 26, 13, 0.8)",i.beginPath(),i.arc(l,c,80,0,2*Math.PI),i.fill(),t.drawHoneycomb(i,r,s,e),t.updateHoneyDrops(i,o,n,s),t.updateBees(i,a,n,s,e),t.transitionTriggered?t.updateTransitionEffect(i,l,c,80,n):t.autoTransitionEnabled&&"playing"===t.game.gameState&&(setTimeout((function(){"playing"===t.game.gameState&&t.triggerTransition()}),2e3),t.autoTransitionEnabled=!1),t.backgroundTexture.needsUpdate=!0}}}),e)}},{key:"drawHoneycomb",value:function(e,t,n,i){var r=i?i.millis()/1e3:performance.now()/1e3,o=function(t,n,i){e.beginPath();for(var r=0;r<6;r++){var o=Math.PI/3*r-Math.PI/6,a=t+i*Math.cos(o),s=n+i*Math.sin(o);0===r?e.moveTo(a,s):e.lineTo(a,s)}e.closePath()};t.forEach((function(t){var i=1+.05*Math.sin(.5*r+t.pulse),a=t.size*i;if(e.fillStyle="rgba(".concat(n.hiveOutline.join(","),", 0.8)"),o(t.x,t.y,1.05*a),e.fill(),e.fillStyle="rgba(".concat(n.honeycomb.join(","),", ").concat(.4+.6*t.z,")"),o(t.x,t.y,a),e.fill(),t.honey){var s=.95+.05*Math.sin(.8*r+.01*t.x+.01*t.y);e.fillStyle="rgba(".concat(n.honeyDrop.join(","),", 0.7)"),o(t.x,t.y,a*t.honeyLevel*s),e.fill();var l=t.x-.2*a,c=t.y-.2*a,h=.3*a;e.fillStyle="rgba(255, 255, 255, 0.4)",e.beginPath(),e.arc(l,c,h,0,2*Math.PI),e.fill()}}))}},{key:"addHoneyDrop",value:function(e,t){e.push({x:Math.random()*t.width,y:-20,size:5+10*Math.random(),speed:.5+1.5*Math.random(),lifetime:0,maxLifetime:100+100*Math.random()})}},{key:"updateHoneyDrops",value:function(e,t,n,i){for(var r=t.length-1;r>=0;r--){var o=t[r];o.y+=o.speed,o.lifetime++,e.fillStyle="rgba(".concat(i.honeyDrop.join(","),", 0.8)"),e.beginPath(),e.arc(o.x,o.y,o.size,0,2*Math.PI),e.fill(),e.fillStyle="rgba(".concat(i.honeyDrop.join(","),", 0.4)");for(var a=1;a<=5;a++){var s=o.y-2*a*o.speed,l=o.size*(1-.15*a);e.beginPath(),e.arc(o.x,s,l,0,2*Math.PI),e.fill()}(o.y>n.height+20||o.lifetime>o.maxLifetime)&&(t.splice(r,1),this.addHoneyDrop(t,n))}}},{key:"updateBees",value:function(e,t,n,i,r){var o=r?r.millis()/1e3:performance.now()/1e3;t.forEach((function(t){t.x+=t.speedX,t.y+=t.speedY,(t.x<0||t.x>n.width)&&(t.speedX*=-1),(t.y<0||t.y>n.height)&&(t.speedY*=-1),e.fillStyle="rgb(".concat(i.bee.join(","),")"),e.beginPath(),e.ellipse(t.x,t.y,t.size,1.5*t.size,Math.atan2(t.speedY,t.speedX),0,2*Math.PI),e.fill(),e.fillStyle="rgb(".concat(i.honeycomb.join(","),")"),e.beginPath(),e.ellipse(t.x-t.speedX*t.size*.2,t.y-t.speedY*t.size*.2,.8*t.size,.8*t.size,Math.atan2(t.speedY,t.speedX),0,2*Math.PI),e.fill();var r=.5*Math.sin(o*t.wingSpeed*10+t.wingPhase);e.fillStyle="rgba(255, 255, 255, 0.7)",e.save(),e.translate(t.x,t.y),e.rotate(Math.atan2(t.speedY,t.speedX)+Math.PI/2+r),e.beginPath(),e.ellipse(.8*-t.size,0,.5*t.size,t.size,0,0,2*Math.PI),e.fill(),e.restore(),e.save(),e.translate(t.x,t.y),e.rotate(Math.atan2(t.speedY,t.speedX)+Math.PI/2-r),e.beginPath(),e.ellipse(.8*t.size,0,.5*t.size,t.size,0,0,2*Math.PI),e.fill(),e.restore()}))}},{key:"updateTransitionEffect",value:function(e,t,n,i,r){this.transitionProgress+=.02,e.fillStyle="rgba(0, 0, 0, ".concat(.5*this.transitionProgress,")"),e.fillRect(0,0,r.width,r.height);var o=i*(1+10*this.transitionProgress);e.fillStyle="rgba(0, 0, 0, 0.9)",e.beginPath(),e.arc(t,n,o,0,2*Math.PI),e.fill();for(var a=0;a<5;a++){var s=Math.random()*Math.PI*2,l=.8*o*Math.random(),c=2+8*Math.random();e.fillStyle="rgba(255, 204, 0, 0.7)",e.beginPath(),e.arc(t+Math.cos(s)*l,n+Math.sin(s)*l,c,0,2*Math.PI),e.fill()}this.transitionProgress>=1&&this.completeTransition()}},{key:"createFallbackAnimation",value:function(){var e=this,t=this.backgroundCanvas.getContext("2d"),n=function(){e.animationStarted||(e.animationStarted=!0),t.fillStyle="#FFF8DC",t.fillRect(0,0,e.backgroundCanvas.width,e.backgroundCanvas.height);var i=e.backgroundCanvas.width/2,r=e.backgroundCanvas.height/2,o=t.createRadialGradient(i,r,40,i,r,160);o.addColorStop(0,"rgba(255, 204, 50, 0.6)"),o.addColorStop(1,"rgba(255, 204, 50, 0)"),t.fillStyle=o,t.beginPath(),t.arc(i,r,160,0,2*Math.PI),t.fill(),t.fillStyle="rgba(40, 26, 13, 0.8)",t.beginPath(),t.arc(i,r,80,0,2*Math.PI),t.fill(),e.backgroundTexture.needsUpdate=!0,e.transitionTriggered?e.updateTransitionEffect(t,i,r,80,e.backgroundCanvas):e.autoTransitionEnabled&&"playing"===e.game.gameState&&(setTimeout((function(){"playing"===e.game.gameState&&e.triggerTransition()}),2e3),e.autoTransitionEnabled=!1),e.animationStarted&&requestAnimationFrame(n)};n()}},{key:"triggerTransition",value:function(){this.transitionTriggered=!0,this.transitionProgress=0}},{key:"completeTransition",value:function(){this.game&&"function"==typeof this.game.switchEnvironment&&this.game.switchEnvironment("interior"),this.transitionTriggered=!1,this.transitionProgress=0}},{key:"update",value:function(){if(this.backgroundPlane&&this.game.camera){var e=this.game.camera.position.clone();if("exterior"===this.game.currentEnvironment){var t=new i.Pq0(0,0,-1).applyQuaternion(this.game.camera.quaternion),n=e.clone().add(t.multiplyScalar(500));this.backgroundPlane.position.copy(n),this.backgroundPlane.lookAt(e)}}}},{key:"checkEntranceCollision",value:function(e,t){return!1}}])&&k(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}();function C(e){return C="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},C(e)}function E(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,T(i.key),i)}}function T(e){var t=function(e){if("object"!=C(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=C(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==C(t)?t:t+""}var A=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.game=t,this.createMenuScreen(),this.createGameOverScreen(),this.createVictoryScreen(),this.createControlsHelp(),this.createVolumeControl(),this.createPauseScreen(),this.updateGameState("menu")},(t=[{key:"createMenuScreen",value:function(){var e=this;this.menuScreen=document.createElement("div"),this.menuScreen.style.position="absolute",this.menuScreen.style.top="0",this.menuScreen.style.left="0",this.menuScreen.style.width="100%",this.menuScreen.style.height="100%",this.menuScreen.style.backgroundColor="rgba(0, 0, 0, 0.7)",this.menuScreen.style.display="flex",this.menuScreen.style.flexDirection="column",this.menuScreen.style.alignItems="center",this.menuScreen.style.justifyContent="center",this.menuScreen.style.color="white",this.menuScreen.style.fontFamily="Arial, sans-serif";var t=document.createElement("h1");t.textContent="Get the Queen",t.style.fontSize="48px",t.style.marginBottom="20px",t.style.color="#ffd700",this.menuScreen.appendChild(t);var n=document.createElement("h2");n.textContent="Fight Till You Die",n.style.fontSize="24px",n.style.marginBottom="40px",n.style.maxWidth="600px",n.style.textAlign="center",this.menuScreen.appendChild(n);var i=this.createButton("Start Game",(function(){return e.game.startGame()}));i.style.marginBottom="20px",this.menuScreen.appendChild(i);var r=this.createButton("Controls",(function(){return e.toggleControlsHelp()}));this.menuScreen.appendChild(r),document.body.appendChild(this.menuScreen)}},{key:"createGameOverScreen",value:function(){var e=this;this.gameOverScreen=document.createElement("div"),this.gameOverScreen.style.position="absolute",this.gameOverScreen.style.top="0",this.gameOverScreen.style.left="0",this.gameOverScreen.style.width="100%",this.gameOverScreen.style.height="100%",this.gameOverScreen.style.backgroundColor="rgba(0, 0, 0, 0.7)",this.gameOverScreen.style.display="none",this.gameOverScreen.style.flexDirection="column",this.gameOverScreen.style.alignItems="center",this.gameOverScreen.style.justifyContent="center",this.gameOverScreen.style.color="white",this.gameOverScreen.style.fontFamily="Arial, sans-serif";var t=document.createElement("h1");t.textContent="Game Over",t.style.fontSize="48px",t.style.marginBottom="20px",t.style.color="#ff4444",this.gameOverScreen.appendChild(t);var n=document.createElement("p");n.textContent="damnnn!!!",n.style.fontSize="24px",n.style.marginBottom="20px",this.gameOverScreen.appendChild(n),this.gameOverTimeDisplay=document.createElement("p"),this.gameOverTimeDisplay.style.fontSize="20px",this.gameOverTimeDisplay.style.marginBottom="30px",this.gameOverScreen.appendChild(this.gameOverTimeDisplay);var i=this.createButton("Try Again",(function(){return e.game.startGame()}));i.style.marginBottom="20px",this.gameOverScreen.appendChild(i),document.body.appendChild(this.gameOverScreen)}},{key:"createVictoryScreen",value:function(){var e=this;this.victoryScreen=document.createElement("div"),this.victoryScreen.style.position="absolute",this.victoryScreen.style.top="0",this.victoryScreen.style.left="0",this.victoryScreen.style.width="100%",this.victoryScreen.style.height="100%",this.victoryScreen.style.backgroundColor="rgba(0, 0, 0, 0.7)",this.victoryScreen.style.display="none",this.victoryScreen.style.flexDirection="column",this.victoryScreen.style.alignItems="center",this.victoryScreen.style.justifyContent="center",this.victoryScreen.style.color="white",this.victoryScreen.style.fontFamily="Arial, sans-serif";var t=document.createElement("h1");t.textContent="Victory!",t.style.fontSize="48px",t.style.marginBottom="20px",t.style.color="#ffd700",this.victoryScreen.appendChild(t);var n=document.createElement("p");n.textContent="Congratulations, You Won",n.style.fontSize="24px",n.style.marginBottom="20px",this.victoryScreen.appendChild(n),this.victoryTimeDisplay=document.createElement("p"),this.victoryTimeDisplay.style.fontSize="20px",this.victoryTimeDisplay.style.marginBottom="30px",this.victoryScreen.appendChild(this.victoryTimeDisplay);var i=this.createButton("Play Again",(function(){return e.game.startGame()}));i.style.marginBottom="20px",this.victoryScreen.appendChild(i),document.body.appendChild(this.victoryScreen)}},{key:"createControlsHelp",value:function(){var e=this;this.controlsHelp=document.createElement("div"),this.controlsHelp.style.position="absolute",this.controlsHelp.style.top="50%",this.controlsHelp.style.left="50%",this.controlsHelp.style.transform="translate(-50%, -50%)",this.controlsHelp.style.width="400px",this.controlsHelp.style.padding="20px",this.controlsHelp.style.backgroundColor="rgba(0, 0, 0, 0.8)",this.controlsHelp.style.borderRadius="10px",this.controlsHelp.style.color="white",this.controlsHelp.style.fontFamily="Arial, sans-serif",this.controlsHelp.style.display="none",this.controlsHelp.style.zIndex="100";var t=document.createElement("h2");t.textContent="Controls",t.style.fontSize="24px",t.style.marginBottom="15px",t.style.textAlign="center",this.controlsHelp.appendChild(t);var n=document.createElement("ul");n.style.listStyleType="none",n.style.padding="0",n.style.marginBottom="20px",[{key:"W / Arrow Up",action:"Turn and move upward"},{key:"S / Arrow Down",action:"Turn and move downward"},{key:"A / Arrow Left",action:"Turn and move left"},{key:"D / Arrow Right",action:"Turn and move right"},{key:"Space",action:"Boost Speed (temporary)"},{key:"P",action:"Pause Game"}].forEach((function(e){var t=document.createElement("li");t.style.margin="10px 0";var i=document.createElement("span");i.textContent=e.key,i.style.display="inline-block",i.style.width="150px",i.style.backgroundColor="#333",i.style.padding="3px 8px",i.style.borderRadius="4px",i.style.marginRight="10px",i.style.textAlign="center";var r=document.createElement("span");r.textContent=e.action,t.appendChild(i),t.appendChild(r),n.appendChild(t)})),this.controlsHelp.appendChild(n);var i=this.createButton("Close",(function(){return e.toggleControlsHelp()}));i.style.margin="0 auto",i.style.display="block",this.controlsHelp.appendChild(i),document.body.appendChild(this.controlsHelp)}},{key:"createButton",value:function(e,t){var n=document.createElement("button");return n.textContent=e,n.style.padding="12px 24px",n.style.fontSize="18px",n.style.backgroundColor="#ffc107",n.style.color="#333",n.style.border="none",n.style.borderRadius="5px",n.style.cursor="pointer",n.style.textAlign="center",n.style.transition="background-color 0.2s",n.addEventListener("mouseover",(function(){n.style.backgroundColor="#ffda44"})),n.addEventListener("mouseout",(function(){n.style.backgroundColor="#ffc107"})),n.addEventListener("click",t),n}},{key:"createPauseScreen",value:function(){var e=this;this.pauseScreen&&document.body.removeChild(this.pauseScreen),this.pauseScreen=document.createElement("div"),this.pauseScreen.style.position="absolute",this.pauseScreen.style.top="0",this.pauseScreen.style.left="0",this.pauseScreen.style.width="100%",this.pauseScreen.style.height="100%",this.pauseScreen.style.backgroundColor="rgba(0, 0, 0, 0.7)",this.pauseScreen.style.display="none",this.pauseScreen.style.flexDirection="column",this.pauseScreen.style.alignItems="center",this.pauseScreen.style.justifyContent="center",this.pauseScreen.style.color="white",this.pauseScreen.style.fontFamily="Arial, sans-serif",this.pauseScreen.style.zIndex="999";var t=document.createElement("h1");if(t.textContent="GAME PAUSED",t.style.fontSize="48px",t.style.marginBottom="40px",t.style.color="#ffd700",this.pauseScreen.appendChild(t),!this.checkIfMobile()){var n=document.createElement("div");n.id="pc-sensitivity-container",n.style.backgroundColor="rgba(0, 0, 0, 0.5)",n.style.padding="20px",n.style.borderRadius="10px",n.style.marginBottom="40px",n.style.minWidth="300px",n.style.textAlign="center";var i=document.createElement("div");i.textContent="Mouse Sensitivity",i.style.fontSize="24px",i.style.marginBottom="15px",n.appendChild(i);var r=document.createElement("div");r.style.display="flex",r.style.alignItems="center",r.style.justifyContent="center";var o=document.createElement("input");o.type="range",o.min="0.2",o.max="3.0",o.step="0.1",o.value=this.game.player?this.game.player.mouseSensitivity:"2.0",o.style.width="200px",o.style.height="25px",o.style.accentColor="#ffd700",o.addEventListener("input",(function(){var t=parseFloat(o.value);e.game.player&&(e.game.player.mouseSensitivity=t,console.log("Sensitivity updated to:",t)),a.textContent=t.toFixed(1)+"x"})),r.appendChild(o);var a=document.createElement("span");a.textContent=o.value+"x",a.style.marginLeft="15px",a.style.fontSize="20px",a.style.minWidth="50px",r.appendChild(a),n.appendChild(r),this.pauseScreen.appendChild(n)}document.body.appendChild(this.pauseScreen)}},{key:"checkIfMobile",value:function(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||"ontouchstart"in window||navigator.maxTouchPoints>0||this.game&&this.game.isMobile||this.game&&this.game.mobileManager&&this.game.mobileManager.isMobile}},{key:"toggleControlsHelp",value:function(){"none"===this.controlsHelp.style.display?this.controlsHelp.style.display="block":this.controlsHelp.style.display="none"}},{key:"updateGameState",value:function(e,t){switch(this.menuScreen.style.display="none",this.gameOverScreen.style.display="none",this.victoryScreen.style.display="none",this.pauseScreen.style.display="none",e){case"menu":this.menuScreen.style.display="flex";break;case"playing":break;case"paused":this.pauseScreen.style.display="flex";break;case"gameover":this.gameOverScreen.style.display="flex",t&&(this.gameOverTimeDisplay.textContent="Time: ".concat(this.formatTime(t)));break;case"victory":this.victoryScreen.style.display="flex",t&&(this.victoryTimeDisplay.textContent="You found the queen in: ".concat(this.formatTime(t)))}}},{key:"formatTime",value:function(e){var t=Math.floor(e/60),n=Math.floor(e%60);return"".concat(t.toString().padStart(2,"0"),":").concat(n.toString().padStart(2,"0"))}},{key:"createVolumeControl",value:function(){var e=this;if(this.volumeControlContainer=document.createElement("div"),this.volumeControlContainer.style.position="absolute",this.volumeControlContainer.style.top="10px",this.volumeControlContainer.style.left="10px",this.volumeControlContainer.style.display="flex",this.volumeControlContainer.style.alignItems="center",this.volumeControlContainer.style.backgroundColor="rgba(0, 0, 0, 0.5)",this.volumeControlContainer.style.padding="5px 8px",this.volumeControlContainer.style.borderRadius="4px",this.volumeControlContainer.style.zIndex="1001",this.volumeControlContainer.style.userSelect="none",this.volumeControlContainer.style.fontFamily="monospace",this.volumeControlContainer.style.fontSize="14px",this.volumeControlContainer.style.transition="opacity 0.3s",this.volumeControlContainer.style.boxShadow="0 2px 4px rgba(0,0,0,0.3)",this.volumeIcon=document.createElement("div"),this.volumeIcon.style.fontSize="18px",this.volumeIcon.style.cursor="pointer",this.volumeIcon.style.marginRight="8px",this.volumeIcon.style.width="18px",this.volumeIcon.style.textAlign="center",this.volumeIcon.textContent="ðŸ”Š",this.volumeIcon.addEventListener("click",(function(){if(e.game.soundManager){var t=e.game.soundManager.toggleMute();e.updateVolumeIcon(t)}})),this.volumeControlContainer.appendChild(this.volumeIcon),this.volumeSlider=document.createElement("input"),this.volumeSlider.type="range",this.volumeSlider.min="0",this.volumeSlider.max="1",this.volumeSlider.step="0.05",this.volumeSlider.value=this.game.soundManager?this.game.soundManager.volume:"1",this.volumeSlider.style.width="60px",this.volumeSlider.style.height="4px",this.volumeSlider.style.cursor="pointer",this.volumeSlider.style.accentColor="#ffd700",this.volumeSlider.style.webkitAppearance="none",this.volumeSlider.style.outline="none",this.volumeSlider.style.background="rgba(255, 255, 255, 0.2)",this.volumeSlider.style.borderRadius="2px",this.volumeControlContainer.style.opacity="0.7",this.volumeControlContainer.addEventListener("mouseenter",(function(){e.volumeControlContainer.style.opacity="1"})),this.volumeControlContainer.addEventListener("mouseleave",(function(){e.volumeControlContainer.style.opacity="0.7"})),this.volumeSlider.addEventListener("input",(function(t){var n=parseFloat(t.target.value);e.game.soundManager&&(e.game.soundManager.setVolume(n),e.updateVolumeIcon(0===n||e.game.soundManager.getMuteState()))})),this.volumeControlContainer.appendChild(this.volumeSlider),document.body.appendChild(this.volumeControlContainer),this.game.soundManager){var t=this.game.soundManager.getMuteState()||"0"===this.volumeSlider.value;this.updateVolumeIcon(t)}setTimeout((function(){e.volumeControlContainer&&(e.volumeControlContainer.style.opacity="0.4")}),3e3)}},{key:"updateVolumeIcon",value:function(e){this.volumeIcon&&(this.volumeIcon.textContent=e?"ðŸ”‡":"ðŸ”Š")}}])&&E(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}();function B(e){return B="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},B(e)}function L(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,z(i.key),i)}}function z(e){var t=function(e){if("object"!=B(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=B(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==B(t)?t:t+""}var I=function(){return e=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.updateInterval=t.updateInterval||500,this.avgSamples=t.samples||20,this.frames=0,this.lastTime=performance.now(),this.fps=0,this.fpsHistory=[],this.lastUpdate=0,this.createDisplay(t)},t=[{key:"createDisplay",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.container=document.createElement("div"),this.container.style.position="absolute",this.container.style.top=e.top||"10px",this.container.style.right=e.right||"10px",this.container.style.backgroundColor=e.bgColor||"rgba(0, 0, 0, 0.5)",this.container.style.color=e.textColor||"#ffffff",this.container.style.padding="6px 10px",this.container.style.borderRadius="4px",this.container.style.fontFamily="monospace",this.container.style.fontSize="14px",this.container.style.zIndex="1000",this.container.style.userSelect="none",this.container.style.transition="background-color 0.3s",document.body.appendChild(this.container),this.container.textContent="FPS: --"}},{key:"update",value:function(){var e=performance.now();if(this.frames++,e-this.lastUpdate>=this.updateInterval){var t=e-this.lastTime,n=1e3*this.frames/t;this.fpsHistory.push(n),this.fpsHistory.length>this.avgSamples&&this.fpsHistory.shift(),this.fps=this.fpsHistory.reduce((function(e,t){return e+t}),0)/this.fpsHistory.length,this.container.textContent="FPS: ".concat(Math.round(this.fps)),this.fps<30?this.container.style.backgroundColor="rgba(255, 0, 0, 0.5)":this.fps<50?this.container.style.backgroundColor="rgba(255, 165, 0, 0.5)":this.container.style.backgroundColor="rgba(0, 128, 0, 0.5)",this.frames=0,this.lastTime=e,this.lastUpdate=e}}},{key:"toggle",value:function(){this.container.style.display="none"===this.container.style.display?"block":"none"}},{key:"show",value:function(){this.container.style.display="block"}},{key:"hide",value:function(){this.container.style.display="none"}},{key:"destroy",value:function(){this.container&&this.container.parentNode&&this.container.parentNode.removeChild(this.container)}}],t&&L(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}();function O(e){return O="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},O(e)}function j(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,D(i.key),i)}}function D(e){var t=function(e){if("object"!=O(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=O(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==O(t)?t:t+""}var F=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.game=t,this.scene=t.scene,this.position=new i.Pq0(0,0,0),this.velocity=new i.Pq0(0,0,0),this.direction=new i.Pq0(0,0,-1),this.accelerate=!1,this.brake=!1,this.moveUp=!1,this.moveDown=!1,this.movementProfiles={exterior:{maxSpeed:.3,moveSpeed:.2,acceleration:.005,deceleration:.01,damping:.98,boostFactor:2,boostDuration:1e3,cameraDistance:8,cameraHeight:3},interior:{maxSpeed:this.isMobile?4.5:3,moveSpeed:this.isMobile?.9:.6,acceleration:this.isMobile?1.2:.8,deceleration:.015,damping:.99,boostFactor:5,boostDuration:1500,cameraDistance:24,cameraHeight:12}},this.currentProfile=this.movementProfiles.exterior,this.speed=0,this.boostActive=!1,this.boostTime=0,this.boostCooldown=3e3,this.lastBoostTime=0,this.verticalSpeed=0,this.maxVerticalSpeed=.3,this.verticalAcceleration=.003,this.verticalDamping=.95,this.yaw=0,this.pitch=0,this.mouseSensitivity=2,this.maxPitchAngle=Math.PI/2.5,this.accelerateWithMouse=!1,this.verticalSpeed=0,this.maxVerticalSpeed=.3,this.verticalAcceleration=.003,this.verticalDamping=.95,this.radius=5.5,this.collisionRecoveryTime=0,this.cameraOffset=new i.Pq0(0,2,5),this.distanceScalingFactor=1,this.targetRotation=new i.PTz,this.currentRotation=new i.PTz,this.applyMovementProfile(),this.createBeeModel()},(t=[{key:"applyMovementProfile",value:function(){this.maxSpeed=this.currentProfile.maxSpeed,this.moveSpeed=this.currentProfile.moveSpeed,this.acceleration=this.currentProfile.acceleration,this.deceleration=this.currentProfile.deceleration,this.damping=this.currentProfile.damping,this.boostFactor=this.currentProfile.boostFactor,this.boostDuration=this.currentProfile.boostDuration}},{key:"switchMovementProfile",value:function(e){this.movementProfiles[e]&&(this.currentProfile=this.movementProfiles[e],this.applyMovementProfile())}},{key:"createBeeModel",value:function(){if(this.model=new i.YJl,this.game.assetManager){var e=this.game.assetManager.getModel("bee");e?(this.model.add(e),e.rotation.y=Math.PI,this.model.scale.set(3,3,3)):this.createFallbackBeeModel()}else this.createFallbackBeeModel();this.scene.add(this.model),this.reset()}},{key:"createFallbackBeeModel",value:function(){var e=new i.Gu$(1,16,16),t=new i.tXL({color:16763904}),n=new i.eaF(e,t);n.scale.set(1,.8,1.2),this.model.add(n);var r=new i.iNn(1.1,.3,.7),o=new i.tXL({color:0}),a=new i.eaF(r,o);a.position.z=.2,this.model.add(a);var s=new i.eaF(r,o);s.position.z=-.2,this.model.add(s)}},{key:"update",value:function(){var e=performance.now();this.boostActive&&e-this.boostTime>this.boostDuration&&(this.boostActive=!1);var t=new i.Pq0(0,0,0),n=new i.Pq0(0,0,-1).applyQuaternion(this.currentRotation);n.normalize();var r=new i.Pq0(1,0,0).applyQuaternion(this.currentRotation);if(this.accelerate&&t.add(n),this.brake&&t.sub(n),this.moveLeft&&t.sub(r),this.moveRight&&t.add(r),t.lengthSq()>0){t.normalize();var o=t.multiplyScalar(this.boostActive?this.maxSpeed*this.boostFactor:this.maxSpeed);this.velocity.lerp(o,.2)}else this.velocity.multiplyScalar(this.damping),this.velocity.length()<.01&&this.velocity.set(0,0,0);this.position.add(this.velocity),this.model.position.copy(this.position),this.model.quaternion.copy(this.currentRotation),this.updateRotation(),this.updateCamera(),this.velocity.lengthSq()}},{key:"createTrailEffect",value:function(){if(this.game&&this.game.particlePool&&!(Math.random()>.3||this.velocity.lengthSq()<.01)){var e=new i.Pq0(0,0,1).applyQuaternion(this.currentRotation),t=this.position.clone().add(e.multiplyScalar(1.5)),n=this.velocity.length(),r=this.boostActive;this.game.particlePool.createEffect({type:"honey",position:t,count:1+Math.floor(2*n),spread:.15,velocity:.02,maxLifetime:r?25:15,onUpdate:function(e){if(e.material){r?e.material.color.setRGB(1,.8,0):e.material.color.setRGB(.8,.8,.2);var t=.1*Math.sin(.01*performance.now())+.9;e.scale.multiplyScalar(t),e.material.opacity-=.04}}})}}},{key:"updateRotation",value:function(){var e=(new i.PTz).setFromAxisAngle(new i.Pq0(0,1,0),this.yaw),t=(new i.PTz).setFromAxisAngle(new i.Pq0(1,0,0),this.pitch);this.targetRotation.copy(e).multiply(t),this.currentRotation.slerp(this.targetRotation,.15)}},{key:"handleBoundaryCollision",value:function(e){this.velocity.copy(e)}},{key:"handleMouseMove",value:function(e,t){var n=.002*this.mouseSensitivity;this.yaw-=e*n,this.pitch-=t*n,this.yaw=this.yaw%(2*Math.PI),this.yaw<0&&(this.yaw+=2*Math.PI);var i=.47*Math.PI;this.pitch=Math.max(-i,Math.min(i,this.pitch))}},{key:"updateCamera",value:function(){var e=this.currentProfile.cameraDistance,t=this.currentProfile.cameraHeight,n=this.position.clone(),r=new i.Pq0(0,0,1).applyQuaternion(this.currentRotation);n.add(r.normalize().multiplyScalar(e)),n.y+=t;var o=300;this.game&&this.game.combatArena&&this.game.combatArena.environment&&(o=300*this.game.combatArena.environment.scale),n.y>o-5&&(n.y=o-5),this.game.camera.position.lerp(n,.2),this.game.camera.lookAt(this.position)}},{key:"boost",value:function(){var e=performance.now();!this.boostActive&&e-this.lastBoostTime>this.boostCooldown&&(this.boostActive=!0,this.boostTime=e,this.lastBoostTime=e,this.createBoostEffect())}},{key:"createBoostEffect",value:function(){if(this.game.particlePool){var e=new i.Pq0(0,0,1).applyQuaternion(this.currentRotation),t=this.position.clone().add(e.clone().multiplyScalar(.6));this.game.particlePool.createEffect({type:"spark",position:t,count:20,spread:.3,velocity:.2,acceleration:new i.Pq0(0,0,0),maxLifetime:30,parent:this.model,onUpdate:function(t){t.position.add(e.clone().multiplyScalar(.1)),t.material.opacity-=.05}})}}},{key:"reset",value:function(){this.position.set(0,100,50),this.velocity.set(0,0,0),this.direction.set(0,0,0),this.accelerate=!1,this.brake=!1,this.moveLeft=!1,this.moveRight=!1,this.boostActive=!1,this.lastBoostTime=0,this.yaw=0,this.pitch=0,this.currentRotation=new i.PTz,this.targetRotation=new i.PTz,this.model.position.copy(this.position),this.model.quaternion.copy(this.currentRotation),this.model.rotation.set(0,0,0),this.updateCamera()}}])&&j(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}();function G(e){return G="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},G(e)}function H(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return q(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?q(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0,r=function(){};return{s:r,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==n.return||n.return()}finally{if(s)throw o}}}}function q(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function R(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,U(i.key),i)}}function U(e){var t=function(e){if("object"!=G(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=G(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==G(t)?t:t+""}var V=function(){return e=function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.game=t,this.parent=n,this.config={playerCooldown:150,maxPlayerBullets:30,maxEnemyBullets:20,bulletSpeed:3,bulletLifetime:400,bulletPoolSize:100,impactParticleCount:6},this.activeBullets=[],this.lastPlayerShotTime=0,this.initBulletPool()},t=[{key:"initBulletPool",value:function(){this.bulletPool=[],this.bulletGeometries={player:new i.Gu$(.4,6,6),enemy:new i.Gu$(.4,6,6)},this.bulletMaterials={player:new i.V9B({color:65535,transparent:!0,opacity:.8}),enemy:new i.V9B({color:16711680,transparent:!0,opacity:.8})};for(var e=0;e<this.config.bulletPoolSize;e++){var t=new i.eaF(this.bulletGeometries.player,this.bulletMaterials.player);t.visible=!1,t.userData={active:!1,isPlayerBullet:!0,direction:new i.Pq0,lifetime:0},this.parent.add(t),this.bulletPool.push(t);var n=new i.eaF(this.bulletGeometries.enemy,this.bulletMaterials.enemy);n.visible=!1,n.userData={active:!1,isPlayerBullet:!1,direction:new i.Pq0,lifetime:0},this.parent.add(n),this.bulletPool.push(n)}this.bulletLights={player:[],enemy:[]};for(var r=0;r<3;r++){var o=new i.HiM(65535,.8,5);o.visible=!1,this.parent.add(o),this.bulletLights.player.push(o)}for(var a=0;a<3;a++){var s=new i.HiM(16711680,.8,5);s.visible=!1,this.parent.add(s),this.bulletLights.enemy.push(s)}this.impactPool={geometries:[new i.Gu$(.05,4,4),new i.Gu$(.04,4,4),new i.Gu$(.03,4,4)],materials:{player:new i.V9B({color:65535,transparent:!0,opacity:.8}),enemy:new i.V9B({color:16711680,transparent:!0,opacity:.8})}}}},{key:"getBulletFromPool",value:function(e){var t,n=0,i=0,r=H(this.activeBullets);try{for(r.s();!(t=r.n()).done;)t.value.userData.isPlayerBullet?n++:i++}catch(e){r.e(e)}finally{r.f()}if(e&&n>=this.config.maxPlayerBullets){var o,a=H(this.activeBullets);try{for(a.s();!(o=a.n()).done;){var s=o.value;if(s.userData.isPlayerBullet)return s}}catch(e){a.e(e)}finally{a.f()}}else if(!e&&i>=this.config.maxEnemyBullets){var l,c=H(this.activeBullets);try{for(c.s();!(l=c.n()).done;){var h=l.value;if(!h.userData.isPlayerBullet)return h}}catch(e){c.e(e)}finally{c.f()}}var u,m=H(this.bulletPool);try{for(m.s();!(u=m.n()).done;){var p=u.value;if(!p.userData.active&&p.userData.isPlayerBullet===e)return p}}catch(e){m.e(e)}finally{m.f()}var d,y=H(this.bulletPool);try{for(y.s();!(d=y.n()).done;){var f=d.value;if(!f.userData.active)return f.material=e?this.bulletMaterials.player:this.bulletMaterials.enemy,f.userData.isPlayerBullet=e,f}}catch(e){y.e(e)}finally{y.f()}if(this.activeBullets.length>0){var v=this.activeBullets[0];return v.userData.isPlayerBullet!==e&&(v.material=e?this.bulletMaterials.player:this.bulletMaterials.enemy,v.userData.isPlayerBullet=e),v}return console.warn("Could not find bullet in pool"),null}},{key:"prewarmSystem",value:function(){for(var e=new i.Pq0(0,0,0),t=new i.Pq0(0,1,0),n=0;n<20;n++){var r=this.createBullet(e,t,!0);r&&this.recycleBullet(r)}for(var o=0;o<20;o++){var a=this.createBullet(e,t,!1);a&&this.recycleBullet(a)}}},{key:"createBullet",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(n){var i=performance.now();if(i-this.lastPlayerShotTime<this.config.playerCooldown)return null;this.lastPlayerShotTime=i}var r=this.getBulletFromPool(n);return r?(r.position.copy(e),r.userData.direction.copy(t),r.userData.lifetime=0,r.userData.active=!0,r.visible=!0,this.activeBullets.includes(r)||this.activeBullets.push(r),r):null}},{key:"recycleBullet",value:function(e){if(e){var t=this.activeBullets.indexOf(e);-1!==t&&this.activeBullets.splice(t,1),e.visible=!1,e.userData.active=!1,e.userData.lifetime=0}}},{key:"update",value:function(e,t){if(0!==this.activeBullets.length)for(var n=this.activeBullets.length-1;n>=0;n--){var i=this.activeBullets[n];if(i.position.addScaledVector(i.userData.direction,this.config.bulletSpeed),i.userData.lifetime++,i.userData.lifetime>this.config.bulletLifetime)this.recycleBullet(i);else{if(!i.userData.isPlayerBullet&&this.game.player&&i.position.distanceTo(this.game.player.position)<1){this.game.handlePlayerHit?this.game.handlePlayerHit():void 0!==this.game.playerHealth&&(this.game.playerHealth-=10,console.log("Player health reduced to:",this.game.playerHealth),this.game.playerHealth<=0&&this.game.endGame(!1)),this.recycleBullet(i);continue}(i.userData.isPlayerBullet&&t&&t.checkBulletEnemyCollisions(i)||e&&e(i.position,.2))&&this.recycleBullet(i)}}}},{key:"reset",value:function(){for(;this.activeBullets.length>0;)this.recycleBullet(this.activeBullets[0]);return this.bulletLights.player.forEach((function(e){return e.visible=!1})),this.bulletLights.enemy.forEach((function(e){return e.visible=!1})),this.lastPlayerShotTime=0,!0}}],t&&R(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}();function _(e){return _="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_(e)}function N(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,W(i.key),i)}}function W(e){var t=function(e){if("object"!=_(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=_(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==_(t)?t:t+""}var Y=function(){return e=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"basic";!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.type=t,this.currentState="patrol",this.targetPosition=new i.Pq0,this.movementVector=new i.Pq0,this.lastStateChange=performance.now(),this.lastDecision=performance.now(),this.decisionInterval=50,this.config={preferredDistance:50,decisionVariability:.3*Math.random(),maxSpeed:.5+2.5*Math.random(),acceleration:.5,turnRate:1.5,maxPitchAngle:Math.PI/3,flankingFactor:.6+.4*Math.random(),aggressiveness:.5+.5*Math.random(),evasiveness:.7*Math.random(),usesFormations:Math.random()>.8,usesAmbush:Math.random()>.7},"boss"===t&&this.configBossEnemy(),this.formationOffset=new i.Pq0(40*(Math.random()-.5),20*(Math.random()-.5),40*(Math.random()-.5))},t=[{key:"configBossEnemy",value:function(){this.config.maxSpeed*=1,this.config.preferredDistance*=.1,this.config.aggressiveness=5,this.config.evasiveness=.8,this.config.usesFormations=!1,this.decisionInterval=300}},{key:"update",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],o=arguments.length>4&&void 0!==arguments[4]&&arguments[4];if(!t)return new i.Pq0;var a=performance.now();return a-this.lastDecision>this.decisionInterval&&(this.updateState(t,n,o),this.lastDecision=a),this.calculateMovement(e,t,n,r)}},{key:"updateState",value:function(e,t,n){var i=this.getDistanceToPlayer(e),r=performance.now()-this.lastStateChange;switch(this.currentState){case"patrol":i<1e3?this.changeState("attack"):r>3e3&&(this.setRandomPatrolPoint(e.position),this.lastStateChange=performance.now());break;case"attack":this.config.flankingFactor>.7&&Math.random()>.7?this.changeState("flank"):n&&Math.random()<this.config.evasiveness?this.changeState("evade"):i>1e3&&this.changeState("patrol");break;case"flank":r>3e3&&this.changeState("attack");break;case"evade":r>2e3&&this.changeState("attack");break;case"formation":i<60*this.config.aggressiveness?this.changeState("attack"):r>4e3&&(this.lastStateChange=performance.now())}this.config.usesFormations&&t.length>2&&"evade"!==this.currentState&&Math.random()>.6&&"formation"!==this.currentState&&this.changeState("formation")}},{key:"changeState",value:function(e){this.currentState=e,this.lastStateChange=performance.now()}},{key:"calculateMovement",value:function(e,t,n,r){var o=new i.Pq0;switch(this.currentState){case"patrol":o.copy(this.calculatePatrolMovement());break;case"attack":o.copy(this.calculateAttackMovement(t));break;case"flank":o.copy(this.calculateFlankMovement(t));break;case"evade":o.copy(this.calculateEvadeMovement(t));break;case"formation":o.copy(this.calculateFormationMovement(t,n))}var a=this.config.maxSpeed*("evade"===this.currentState?1.2:1);return o.normalize().multiplyScalar(a),this.movementVector.copy(o),o}},{key:"calculatePatrolMovement",value:function(){var e=performance.now(),t=new i.Pq0;if(this.targetPosition.lengthSq()>0){t.subVectors(this.targetPosition,this.currentPosition||new i.Pq0).normalize();var n=.2*Math.sin(.001*e);t.x+=n,t.y+=.1*Math.sin(.0015*e)}else this.setRandomPatrolPoint(),t.set(Math.random()-.5,Math.random()-.5,Math.random()-.5).normalize();return t}},{key:"calculateAttackMovement",value:function(e){var t=new i.Pq0,n=this.calculateLeadPosition(e);return t.subVectors(n,this.currentPosition||new i.Pq0),t.length()<this.config.preferredDistance*this.config.aggressiveness?t.negate().multiplyScalar(.5):t.normalize(),t}},{key:"calculateFlankMovement",value:function(e){var t=new i.Pq0;t.subVectors(e.position,this.currentPosition||new i.Pq0);var n=new i.Pq0(-t.z,0,t.x).normalize(),r=1.5*this.config.flankingFactor;return t.normalize(),t.add(n.multiplyScalar(r)),t}},{key:"calculateEvadeMovement",value:function(e){var t=new i.Pq0;return t.subVectors(this.currentPosition||new i.Pq0,e.position),t.x+=2*(Math.random()-.5),t.y+=2*(Math.random()-.5),t.z+=2*(Math.random()-.5),t.normalize()}},{key:"calculateFormationMovement",value:function(e,t){var n=new i.Pq0;n.subVectors(e.position,this.currentPosition||new i.Pq0);var r=n.length();r<120?n.negate().multiplyScalar(.5):r>170?n.normalize():n.set(0,0,0);var o=new i.Pq0(0,0,-1).applyQuaternion(e.quaternion||new i.PTz).normalize(),a=new i.Pq0(1,0,0).applyQuaternion(e.quaternion||new i.PTz),s=new i.Pq0(0,1,0);return n.add(a.clone().multiplyScalar(this.formationOffset.x).add(s.clone().multiplyScalar(this.formationOffset.y).add(o.clone().multiplyScalar(this.formationOffset.z)))),n.normalize()}},{key:"setCurrentPosition",value:function(e){this.currentPosition=e.clone()}},{key:"getMovementVector",value:function(){return this.movementVector}},{key:"calculateLeadPosition",value:function(e){var t=e.position.clone();if(e.velocity){var n=this.getDistanceToPlayer(e),i=Math.min(n/100,1.5);t.add(e.velocity.clone().multiplyScalar(i))}return t}},{key:"getDistanceToPlayer",value:function(e){if(!this.currentPosition)return 1e3;var t=e.position.x-this.currentPosition.x,n=e.position.y-this.currentPosition.y,i=e.position.z-this.currentPosition.z;return Math.sqrt(t*t+n*n+i*i)}},{key:"setRandomPatrolPoint",value:function(e){var t=e||new i.Pq0,n=100+1500*Math.random(),r=Math.random()*Math.PI*2,o=100*Math.random()-50;this.targetPosition.set(t.x+Math.cos(r)*n,t.y+o,t.z+Math.sin(r)*n)}},{key:"getRotationQuaternion",value:function(e){if(!e||0===e.lengthSq())return new i.PTz;var t=new i.kn4;t.lookAt(new i.Pq0(0,0,0),e,new i.Pq0(0,1,0));var n=new i.PTz;return n.setFromRotationMatrix(t),n}}],t&&N(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}();function Q(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"normal",n=new Y(e);return"hard"===t?(n.config.maxSpeed*=1.3,n.config.flankingFactor*=1.5,n.config.aggressiveness*=1.3,n.decisionInterval*=.7):"easy"===t&&(n.config.maxSpeed*=.8,n.config.flankingFactor*=.7,n.config.aggressiveness*=.7,n.decisionInterval*=1.5),n}function $(e){return $="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},$(e)}function X(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,K(i.key),i)}}function K(e){var t=function(e){if("object"!=$(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=$(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==$(t)?t:t+""}var Z=function(){return e=function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.game=t,this.parent=n,this.enemies=[],this.enemiesDefeated=0,this.totalEnemies=100,this.lastSpawnTime=0,this.spawnInterval=4e3,this.maxEnemies=15,this.bossSpawned=!1,this.bossDefeated=!1,this.bossEnemy=null,this.waveNumber=1,this.enemiesPerWave=10,this.enemiesRemainingInWave=this.enemiesPerWave,this.timeBetweenWaves=5e3,this.lastWaveTime=0,this.isWaveActive=!1,this.canSpawnGroups=!1,this.groupSize=3,this.groupSpawnChance=.3,this.createGlobalEnemyLights(),this.initSpatialGrid(),this.initInstancedEnemies(),this.initHealthBars()},t=[{key:"initHealthBars",value:function(){this.healthBarGeometry=new i.bdM(6,.8),this.healthBarBgMaterial=new i.V9B({color:3355443,transparent:!0,opacity:.7,depthTest:!1}),this.healthBarFillMaterial=new i.V9B({color:16724787,transparent:!0,opacity:.8,depthTest:!1}),this.healthBars={},this.healthBarConfig={showDuration:3e3,fadeTime:1e3,yOffset:5,maxAlpha:.8}}},{key:"updateEnemyHealthBar",value:function(e){var t=e.instanceId,n=e.userData.health/100;if(!this.healthBars[t]){var r=new i.YJl,o=new i.eaF(this.healthBarGeometry,this.healthBarBgMaterial.clone()),a=new i.eaF(this.healthBarGeometry,this.healthBarFillMaterial.clone());a.position.z=.01,r.add(o),r.add(a),this.parent.add(r),this.healthBars[t]={group:r,background:o,fill:a,lastHitTime:performance.now(),visible:!0}}var s=this.healthBars[t];s.lastHitTime=performance.now(),s.visible=!0,s.background.material.opacity=this.healthBarConfig.maxAlpha,s.fill.material.opacity=this.healthBarConfig.maxAlpha,s.fill.scale.x=Math.max(.01,n),s.fill.position.x=3*(n-1),n>.6?s.fill.material.color.setRGB(.2,.8,.2):n>.3?s.fill.material.color.setRGB(.9,.9,.2):s.fill.material.color.setRGB(.9,.2,.2)}},{key:"updateHealthBars",value:function(){var e=this,t=performance.now(),n=this.game.camera;if(n){var i=function(i){var r=e.healthBars[i],o=e.enemies.find((function(e){return e.instanceId===parseInt(i)}));if(!o)return r.group.parent&&r.group.parent.remove(r.group),delete e.healthBars[i],1;var a=t-r.lastHitTime;if(a>e.healthBarConfig.showDuration){var s=Math.min(1,(a-e.healthBarConfig.showDuration)/e.healthBarConfig.fadeTime),l=e.healthBarConfig.maxAlpha*(1-s);r.background.material.opacity=l,r.fill.material.opacity=l,s>=1&&(r.visible=!1)}r.visible&&(r.group.position.copy(o.position),r.group.position.y+=e.healthBarConfig.yOffset,r.group.lookAt(n.position))};for(var r in this.healthBars)i(r)}}},{key:"createGlobalEnemyLights",value:function(){var e=[[150,50,150],[-150,50,150],[150,50,-150],[-150,50,-150]];this.enemyLights=[];for(var t=0;t<e.length;t++){var n=new i.HiM(16733440,.8,200);n.position.set(e[t][0],e[t][1],e[t][2]),this.parent.add(n),this.enemyLights.push(n)}}},{key:"initSpatialGrid",value:function(){this.gridCellSize=200,this.gridSize=20,this.grid=[];for(var e=0;e<this.gridSize;e++){this.grid[e]=[];for(var t=0;t<this.gridSize;t++)this.grid[e][t]=[]}}},{key:"updateSpatialGrid",value:function(){for(var e=0;e<this.gridSize;e++)for(var t=0;t<this.gridSize;t++)this.grid[e][t]=[];for(var n=0;n<this.enemies.length;n++){var i=this.enemies[n],r=Math.floor(i.position.x/this.gridCellSize+this.gridSize/2),o=Math.floor(i.position.z/this.gridCellSize+this.gridSize/2);r>=0&&r<this.gridSize&&o>=0&&o<this.gridSize&&this.grid[r][o].push(i)}}},{key:"spawnInitialEnemies",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:3;this.createEnemy();for(var n=1;n<t;n++)setTimeout((function(){e.createEnemy()}),500*n)}},{key:"initInstancedEnemies",value:function(){var e,t;if(this.instanceCount=this.maxEnemies,this.game.assetManager){var n=this.game.assetManager.getModel("ant",!1);n?n.traverse((function(n){n.isMesh&&!e&&(e=n.geometry,t=n.material.clone())})):console.log("[EnemyManager] 'ant' model NOT found in AssetManager.")}else console.log("[EnemyManager] AssetManager not available.");e||(console.log("[EnemyManager] Using fallback SphereGeometry."),e=new i.Gu$(1,8,8),t=new i.tXL({color:16720384,emissive:4460800,shininess:50})),this.enemyInstances=new i.ZLX(e,t,this.instanceCount),this.enemyInstances.instanceMatrix.setUsage(i.Vnu),this.enemyInstances.frustumCulled=!1,this.parent.add(this.enemyInstances)}},{key:"createEnemy",value:function(){var e=this.enemies.length;if(e>=this.instanceCount)return null;var t=Math.random()*Math.PI*2,n=1e3*Math.random(),r=50+1400*Math.random(),o=new i.Pq0(Math.cos(t)*n,r,Math.sin(t)*n),a={position:o,quaternion:new i.PTz,instanceId:e,userData:{health:100,speed:this.enemyBaseSpeed||.5,velocity:new i.Pq0,targetDirection:new i.Pq0,rotationSpeed:.1,maxSpeed:.5,acceleration:.5,currentSpeed:0,state:"patrolling",target:new i.Pq0,lastStateChange:performance.now(),lastAttackTime:0,attackCooldown:2e3+1e3*Math.random(),patrolRadius:80+100*Math.random(),originalPosition:o.clone()},aiController:Q(Math.random()>.8?"aggressive":"basic")},s=new i.kn4;return s.setPosition(o),this.enemyInstances.setMatrixAt(e,s),this.enemyInstances.instanceMatrix.needsUpdate=!0,this.setNewPatrolTarget(a),this.enemies.push(a),a}},{key:"increaseWaveDifficulty",value:function(){this.waveNumber++,this.enemiesPerWave=Math.min(5+Math.floor(1.5*this.waveNumber),20),this.waveNumber>=3&&(this.canSpawnGroups=!0,this.groupSpawnChance=Math.min(.3+.05*(this.waveNumber-3),.6),this.groupSize=Math.min(3+Math.floor((this.waveNumber-3)/2),6)),this.spawnInterval=Math.max(4e3-200*this.waveNumber,1500),this.maxEnemies=Math.min(5+Math.floor(this.waveNumber/2),15),this.enemyBaseHealth=100+10*this.waveNumber,this.enemyBaseSpeed=.8,this.enemiesRemainingInWave=this.enemiesPerWave,this.isWaveActive=!1}},{key:"spawnEnemyGroup",value:function(e){for(var t=this.getSpawnPosition(),n=0;n<e;n++){var r=n/e*Math.PI*2,o=new i.Pq0(20*Math.cos(r),n%2*10,20*Math.sin(r)),a=this.createEnemyAt(t.clone().add(o));a&&a.userData&&(a.userData.speed*=1.1)}}},{key:"createEnemyAt",value:function(e){var t=this.enemies.length;if(t>=this.instanceCount)return null;var n={position:e,quaternion:new i.PTz,instanceId:t,userData:{health:this.enemyBaseHealth||100,speed:this.enemyBaseSpeed||.05+.05*Math.random(),state:"patrolling",target:new i.Pq0,lastStateChange:performance.now(),lastAttackTime:0,attackCooldown:2e3+1e3*Math.random(),patrolRadius:80+70*Math.random(),originalPosition:e.clone()},aiController:Q(Math.random()>.8?"aggressive":"basic")},r=new i.kn4;return r.setPosition(e),this.enemyInstances.setMatrixAt(t,r),this.enemyInstances.instanceMatrix.needsUpdate=!0,this.setNewPatrolTarget(n),this.enemies.push(n),n}},{key:"getSpawnPosition",value:function(){var e=new i.Pq0,t=(this.game.player?this.game.player.position:new i.Pq0,Math.random()*Math.PI*2),n=130+1670*Math.random();return e.set(Math.cos(t)*n,50+1400*Math.random(),Math.sin(t)*n),e}},{key:"setNewPatrolTarget",value:function(e){var t=Math.random()*Math.PI*2,n=Math.random()*e.userData.patrolRadius,i=e.userData.originalPosition;return e.userData.target.set(i.x+Math.cos(t)*n,i.y+(50*Math.random()-25),i.z+Math.sin(t)*n),e.userData.target}},{key:"createFallbackEnemyModel",value:function(e){}},{key:"spawnBoss",value:function(){if(!this.bossSpawned){console.log("Boss fight starting!"),this.bossSpawned=!0,this.bossBar=document.createElement("div"),this.bossBar.style.cssText="position:fixed;top:20px;left:20%;right:20%;height:20px;background:#333;border-radius:5px;z-index:100;",this.bossBarFill=document.createElement("div"),this.bossBarFill.style.cssText="width:100%;height:100%;background:red;border-radius:5px;transition:width 0.3s;",this.bossBar.appendChild(this.bossBarFill),document.body.appendChild(this.bossBar);var e,t,n,r=new i.Pq0(0,50,0);if(this.bossEnemy=(e={position:r,quaternion:new i.PTz,model:null,aiController:Q("boss"),userData:{health:500,speed:2,velocity:new i.Pq0,state:"attacking",lastAttackTime:0,rotationSpeed:.1}},t="aiController",n=Q("boss","hard"),(t=K(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e),this.game.assetManager){var o=this.game.assetManager.getModel("ant")||this.game.assetManager.getModel("bee");o&&(o.scale.set(50,50,50),this.bossEnemy.model=o,this.parent.add(o),o.position.copy(r))}}}},{key:"update",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:16.667;if(this.bossEnemy&&this.bossEnemy.model&&(this.bossEnemy.model.position.copy(this.bossEnemy.position),this.bossEnemy.model.quaternion.copy(this.bossEnemy.quaternion),this.bossEnemy.rotationFixed||(this.bossEnemy.model.rotation.y=Math.PI,this.bossEnemy.rotationFixed=!0)),this.bossEnemy&&this.bossEnemy.aiController&&this.game.player){this.bossEnemy.aiController.setCurrentPosition(this.bossEnemy.position);var t=this.bossEnemy.aiController.update(e,this.game.player,this.enemies,[],!1);if(t){var n=this.bossEnemy.userData.speed;this.bossEnemy.position.add(t.clone().multiplyScalar(n))}}if(this.bossEnemy&&this.game.player){var r=performance.now(),o=this.bossEnemy.userData;if(r-o.lastAttackTime>(o.attackCooldown||1500)){var a=this.bossEnemy.position.distanceTo(this.game.player.position);if(a<350){var s=.8-a/500;s*=3,Math.random()<s&&(this.enemyShoot(this.bossEnemy),o.lastAttackTime=r)}}}if(this.enemies&&0!==this.enemies.length){this.updateSpatialGrid();var l=performance.now();if(!this.isWaveActive&&this.enemiesRemainingInWave>0&&l-this.lastWaveTime>this.timeBetweenWaves&&(this.isWaveActive=!0),this.isWaveActive&&this.enemies.length<this.maxEnemies&&this.enemiesRemainingInWave>0){var c=1;this.canSpawnGroups&&Math.random()<this.groupSpawnChance&&(c=Math.min(this.groupSize,this.enemiesRemainingInWave)),l-this.lastSpawnTime>this.spawnInterval&&(c>1?this.spawnEnemyGroup(c):this.createEnemy(),this.enemiesRemainingInWave-=c,this.lastSpawnTime=l,this.enemiesRemainingInWave<=0&&(this.isWaveActive=!1,this.lastWaveTime=l))}this.enemiesRemainingInWave<=0&&0===this.enemies.length&&!this.isWaveActive&&l-this.lastWaveTime>this.timeBetweenWaves&&this.increaseWaveDifficulty(),this.enemyInstances&&(this.enemyInstances.instanceMatrix.needsUpdate=!1);for(var h=this.enemies.length-1;h>=0;h--){var u=this.enemies[h],m=u.userData;if(m.velocity||(m.velocity=new i.Pq0,m.rotationSpeed=.1),this.game.player&&l-m.lastAttackTime>m.attackCooldown){var p=u.position.distanceTo(this.game.player.position);if(p<150){var d=.6-p/300;u.aiController&&u.aiController.config&&u.aiController.config.aggressiveness>.7&&(d*=1.5),Math.random()<d&&(this.enemyShoot(u),m.lastAttackTime=l)}}u.aiController.setCurrentPosition(u.position);var y=u.aiController.update(e,this.game.player,this.enemies,[],!1).clone().multiplyScalar(m.speed);if(m.velocity.lerp(y,.7),"stunned"===m.state&&m.velocity.multiplyScalar(.7),this.game.collisionSystem&&this.game.collidersRegistered&&this.game.collisionSystem.checkCollisions(u,7),u.position.add(m.velocity),m.velocity.lengthSq()>.01){var f=m.velocity.clone().normalize(),v=new i.PTz,g=new i.kn4;g.lookAt(new i.Pq0(0,0,0),f,new i.Pq0(0,1,0)),v.setFromRotationMatrix(g),u.quaternion.slerp(v,.6*m.rotationSpeed),this.updateHealthBars()}if(this.enemyInstances){var b=new i.kn4,w=new i.Pq0(15,15,15),x=new i.PTz;x.copy(u.quaternion);var S=(new i.PTz).setFromAxisAngle(new i.Pq0(0,1,0),Math.PI),k=(new i.PTz).setFromAxisAngle(new i.Pq0(1,0,0),Math.PI/2);x.multiply(S),x.multiply(k),b.compose(u.position,x,w),this.enemyInstances.setMatrixAt(u.instanceId,b)}}this.enemyInstances&&(this.enemyInstances.instanceMatrix.needsUpdate=!0),this.enemies.length<this.maxEnemies&&l-this.lastSpawnTime>this.spawnInterval&&this.enemiesDefeated<this.totalEnemies&&(this.createEnemy(),this.lastSpawnTime=l)}}},{key:"moveTowardTarget",value:function(e,t,n){if(e&&t){var r=(new i.Pq0).subVectors(t,e.position).normalize();e.position.add(r.multiplyScalar(n)),e.position.y+=.02*Math.sin(.002*performance.now())}}},{key:"lookAtTarget",value:function(e,t){if(e&&t){(new i.Pq0).subVectors(t,e.position);var n=new i.kn4;n.lookAt(e.position,t,new i.Pq0(0,1,0)),e.quaternion.setFromRotationMatrix(n);var r=(new i.PTz).setFromAxisAngle(new i.Pq0(0,1,0),Math.PI);e.quaternion.multiply(r)}}},{key:"enemyShoot",value:function(e){if(this.game.combatArena&&this.game.player){var t=e.position.clone(),n=this.game.player.position.clone(),r=t.distanceTo(n)/30*.1;n.x+=(2*Math.random()-1)*r,n.y+=(2*Math.random()-1)*r,n.z+=(2*Math.random()-1)*r;var o=(new i.Pq0).subVectors(n,t).normalize();this.game.combatArena.bulletManager&&(this.game.combatArena.bulletManager.createBullet(t,o,!1),this.game.soundManager.playSound("shoot"))}}},{key:"handleEnemyHit",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:25;if(e)if(this.bossEnemy&&e===this.bossEnemy){if(e.userData.health-=t,this.bossBarFill){var n=Math.max(0,e.userData.health/500*100);this.bossBarFill.style.width=n+"%"}e.userData.health<=0&&(this.bossDefeated=!0,e.model&&this.parent.remove(e.model),"function"==typeof this.onEnemyDefeated&&this.onEnemyDefeated(1e3),this.game.endGame&&this.game.endGame(!0))}else e.userData.health-=t,this.updateEnemyHealthBar(e),e.userData.health<=0?("function"==typeof this.onEnemyDefeated&&this.onEnemyDefeated(100),this.destroyEnemy(e)):(this.showEnemyHitEffect(e.position),e.userData.state="stunned",e.userData.lastStateChange=performance.now())}},{key:"showEnemyHitEffect",value:function(e){this.game&&this.game.particlePool&&this.game.particlePool.createEffect({type:"spark",position:e.clone(),count:15,spread:1,velocity:.25,maxLifetime:30})}},{key:"destroyEnemy",value:function(e){var t=this.enemies.indexOf(e);if(-1!==t){if(this.game&&this.game.particlePool&&(this.game.particlePool.createExplosion(e.position.clone(),{count:10,spread:1.2,velocity:.25,lifetime:60}),this.game.particlePool.createEffect({type:"honey",position:e.position.clone(),count:12,spread:1,velocity:.2,maxLifetime:50})),this.enemies.splice(t,1),this.enemyInstances){var n=new i.kn4;n.compose(new i.Pq0(1e4,1e4,1e4),new i.PTz,new i.Pq0(1,1,1)),this.enemyInstances.setMatrixAt(e.instanceId,n),this.enemyInstances.instanceMatrix.needsUpdate=!0}this.enemiesDefeated++,this.checkVictoryCondition()&&this.game.endGame(!0)}}},{key:"checkBulletEnemyCollisions",value:function(e){if(!e||!e.userData||!e.userData.isPlayerBullet)return!1;if(this.bossEnemy&&this.bossEnemy.model&&e.position.distanceTo(this.bossEnemy.position)<25)return this.handleEnemyHit(this.bossEnemy),!0;for(var t=0;t<this.enemies.length;t++){var n=this.enemies[t];if(e.position.distanceTo(n.position)<25)return this.handleEnemyHit(n),!0}return!1}},{key:"checkVictoryCondition",value:function(){return!!this.bossDefeated||!this.bossSpawned&&this.enemiesDefeated>=this.totalEnemies&&(this.spawnBoss(),!1)}},{key:"reset",value:function(){if(this.enemies=[],this.enemiesDefeated=0,this.lastSpawnTime=0,this.enemyInstances){var e=new i.kn4;e.setPosition(1e4,1e4,1e4);for(var t=0;t<this.instanceCount;t++)this.enemyInstances.setMatrixAt(t,e);this.enemyInstances.instanceMatrix.needsUpdate=!0}return!0}}],t&&X(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}();function J(e){return J="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},J(e)}function ee(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function te(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,ne(i.key),i)}}function ne(e){var t=function(e){if("object"!=J(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=J(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==J(t)?t:t+""}var ie=function(){return e=function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.game=t,this.arenaGroup=n,this.powerUps=[],this.types=["health","speed","weapon"],this.spawnInterval=15e3,this.lastSpawnTime=0,this.maxPowerUps=5,this.initGeometryAndMaterials()},t=[{key:"initGeometryAndMaterials",value:function(){this.geometry=new i.Ufg(3,0),this.materials={health:new i.tXL({color:16711680,emissive:3342336,shininess:50,transparent:!0,opacity:.8}),speed:new i.tXL({color:65535,emissive:13107,shininess:50,transparent:!0,opacity:.8}),weapon:new i.tXL({color:16755200,emissive:3351040,shininess:50,transparent:!0,opacity:.8})}}},{key:"spawnPowerUp",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this.powerUps.length>=this.maxPowerUps&&this.removePowerUp(this.powerUps[0]);var t=e||this.types[Math.floor(Math.random()*this.types.length)],n=new i.eaF(this.geometry,this.materials[t]),r=this.getSpawnPosition();n.position.copy(r),this.arenaGroup.add(n);var o=new i.HiM(this.materials[t].color,1,30);o.position.copy(r),n.add(o);var a={mesh:n,type:t,effect:this.getEffectForType(t),createdAt:performance.now()};return this.powerUps.push(a),this.lastSpawnTime=performance.now(),a}},{key:"getSpawnPosition",value:function(){var e=new i.Pq0,t=this.game.player?this.game.player.position:new i.Pq0,n=0;do{var r=Math.random()*Math.PI*2,o=50+150*Math.random(),a=50+100*Math.random();e.set(Math.cos(r)*o,a,Math.sin(r)*o),n++}while(e.distanceTo(t)<50&&n<10);return e}},{key:"getEffectForType",value:function(e){var t=this;switch(e){case"health":return function(e){void 0!==t.game.playerHealth&&(t.game.playerHealth=Math.min(100,t.game.playerHealth+25),t.showEffectText("+".concat(25," Health"),16711680))};case"speed":return function(e){var n=e.maxSpeed;e.maxSpeed*=1.5,t.showEffectText("Speed Boost!",65535),setTimeout((function(){e.maxSpeed=n}),2e4)};case"weapon":return function(e){if(t.game.combatArena&&t.game.combatArena.bulletManager){var n=t.game.combatArena.bulletManager,i=n.config.playerCooldown;n.config.playerCooldown=i/2,t.showEffectText("Weapon Upgrade!",16755200),setTimeout((function(){n.config.playerCooldown=i}),15e3)}};default:return function(){}}}},{key:"showEffectText",value:function(e,t){if(document&&document.body){var n=document.createElement("div");n.textContent=e,n.style.position="absolute",n.style.color="#"+new i.Q1f(t).getHexString(),n.style.fontSize="24px",n.style.fontWeight="bold",n.style.top="50%",n.style.left="50%",n.style.transform="translate(-50%, -50%)",n.style.textShadow="0 0 5px black",n.style.pointerEvents="none",n.style.zIndex="1000",n.style.transition="all 1s ease-out",document.body.appendChild(n),setTimeout((function(){n.style.opacity="0",n.style.transform="translate(-50%, -150%)",setTimeout((function(){n.parentNode&&document.body.removeChild(n)}),1e3)}),50)}}},{key:"checkCollisions",value:function(e,t){if(e&&0!==this.powerUps.length)for(var n=this.powerUps.length-1;n>=0;n--){var i=this.powerUps[n];i.mesh&&e.distanceTo(i.mesh.position)<t+5&&(this.game.soundManager&&this.game.soundManager.playSound("pickup"),i.effect&&this.game.player&&i.effect(this.game.player),this.removePowerUp(i))}}},{key:"removePowerUp",value:function(e){var t=this.powerUps.indexOf(e);-1!==t&&(this.powerUps.splice(t,1),e.mesh&&e.mesh.parent&&e.mesh.parent.remove(e.mesh))}},{key:"update",value:function(){var e=performance.now();e-this.lastSpawnTime>this.spawnInterval&&this.powerUps.length<this.maxPowerUps&&this.spawnPowerUp();var t,n=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return ee(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?ee(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0,r=function(){};return{s:r,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==n.return||n.return()}finally{if(s)throw o}}}}(this.powerUps);try{for(n.s();!(t=n.n()).done;){var i=t.value;i.mesh&&(i.mesh.rotation.y+=.02,i.mesh.rotation.x+=.01,i.mesh.position.y+=.05*Math.sin(.001*e))}}catch(e){n.e(e)}finally{n.f()}this.game.player&&this.game.player.position&&this.checkCollisions(this.game.player.position,this.game.player.radius||2)}},{key:"reset",value:function(){for(;this.powerUps.length>0;)this.removePowerUp(this.powerUps[0]);return this.lastSpawnTime=0,!0}}],t&&te(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}();function re(e){return re="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},re(e)}function oe(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var i,r,o,a,s=[],l=!0,c=!1;try{if(o=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;l=!1}else for(;!(l=(i=o.call(n)).done)&&(s.push(i.value),s.length!==t);l=!0);}catch(e){c=!0,r=e}finally{try{if(!l&&null!=n.return&&(a=n.return(),Object(a)!==a))return}finally{if(c)throw r}}return s}}(e,t)||function(e,t){if(e){if("string"==typeof e)return ae(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?ae(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ae(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function se(){se=function(){return t};var e,t={},n=Object.prototype,i=n.hasOwnProperty,r=Object.defineProperty||function(e,t,n){e[t]=n.value},o="function"==typeof Symbol?Symbol:{},a=o.iterator||"@@iterator",s=o.asyncIterator||"@@asyncIterator",l=o.toStringTag||"@@toStringTag";function c(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(e){c=function(e,t,n){return e[t]=n}}function h(e,t,n,i){var o=t&&t.prototype instanceof v?t:v,a=Object.create(o.prototype),s=new B(i||[]);return r(a,"_invoke",{value:C(e,n,s)}),a}function u(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=h;var m="suspendedStart",p="suspendedYield",d="executing",y="completed",f={};function v(){}function g(){}function b(){}var w={};c(w,a,(function(){return this}));var x=Object.getPrototypeOf,S=x&&x(x(L([])));S&&S!==n&&i.call(S,a)&&(w=S);var k=b.prototype=v.prototype=Object.create(w);function P(e){["next","throw","return"].forEach((function(t){c(e,t,(function(e){return this._invoke(t,e)}))}))}function M(e,t){function n(r,o,a,s){var l=u(e[r],e,o);if("throw"!==l.type){var c=l.arg,h=c.value;return h&&"object"==re(h)&&i.call(h,"__await")?t.resolve(h.__await).then((function(e){n("next",e,a,s)}),(function(e){n("throw",e,a,s)})):t.resolve(h).then((function(e){c.value=e,a(c)}),(function(e){return n("throw",e,a,s)}))}s(l.arg)}var o;r(this,"_invoke",{value:function(e,i){function r(){return new t((function(t,r){n(e,i,t,r)}))}return o=o?o.then(r,r):r()}})}function C(t,n,i){var r=m;return function(o,a){if(r===d)throw Error("Generator is already running");if(r===y){if("throw"===o)throw a;return{value:e,done:!0}}for(i.method=o,i.arg=a;;){var s=i.delegate;if(s){var l=E(s,i);if(l){if(l===f)continue;return l}}if("next"===i.method)i.sent=i._sent=i.arg;else if("throw"===i.method){if(r===m)throw r=y,i.arg;i.dispatchException(i.arg)}else"return"===i.method&&i.abrupt("return",i.arg);r=d;var c=u(t,n,i);if("normal"===c.type){if(r=i.done?y:p,c.arg===f)continue;return{value:c.arg,done:i.done}}"throw"===c.type&&(r=y,i.method="throw",i.arg=c.arg)}}}function E(t,n){var i=n.method,r=t.iterator[i];if(r===e)return n.delegate=null,"throw"===i&&t.iterator.return&&(n.method="return",n.arg=e,E(t,n),"throw"===n.method)||"return"!==i&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+i+"' method")),f;var o=u(r,t.iterator,n.arg);if("throw"===o.type)return n.method="throw",n.arg=o.arg,n.delegate=null,f;var a=o.arg;return a?a.done?(n[t.resultName]=a.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,f):a:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,f)}function T(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function A(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function B(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(T,this),this.reset(!0)}function L(t){if(t||""===t){var n=t[a];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var r=-1,o=function n(){for(;++r<t.length;)if(i.call(t,r))return n.value=t[r],n.done=!1,n;return n.value=e,n.done=!0,n};return o.next=o}}throw new TypeError(re(t)+" is not iterable")}return g.prototype=b,r(k,"constructor",{value:b,configurable:!0}),r(b,"constructor",{value:g,configurable:!0}),g.displayName=c(b,l,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===g||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,b):(e.__proto__=b,c(e,l,"GeneratorFunction")),e.prototype=Object.create(k),e},t.awrap=function(e){return{__await:e}},P(M.prototype),c(M.prototype,s,(function(){return this})),t.AsyncIterator=M,t.async=function(e,n,i,r,o){void 0===o&&(o=Promise);var a=new M(h(e,n,i,r),o);return t.isGeneratorFunction(n)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},P(k),c(k,l,"Generator"),c(k,a,(function(){return this})),c(k,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var i in t)n.push(i);return n.reverse(),function e(){for(;n.length;){var i=n.pop();if(i in t)return e.value=i,e.done=!1,e}return e.done=!0,e}},t.values=L,B.prototype={constructor:B,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(A),!t)for(var n in this)"t"===n.charAt(0)&&i.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function r(i,r){return s.type="throw",s.arg=t,n.next=i,r&&(n.method="next",n.arg=e),!!r}for(var o=this.tryEntries.length-1;o>=0;--o){var a=this.tryEntries[o],s=a.completion;if("root"===a.tryLoc)return r("end");if(a.tryLoc<=this.prev){var l=i.call(a,"catchLoc"),c=i.call(a,"finallyLoc");if(l&&c){if(this.prev<a.catchLoc)return r(a.catchLoc,!0);if(this.prev<a.finallyLoc)return r(a.finallyLoc)}else if(l){if(this.prev<a.catchLoc)return r(a.catchLoc,!0)}else{if(!c)throw Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return r(a.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc<=this.prev&&i.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var o=r;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var a=o?o.completion:{};return a.type=e,a.arg=t,o?(this.method="next",this.next=o.finallyLoc,f):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),f},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),A(n),f}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var i=n.completion;if("throw"===i.type){var r=i.arg;A(n)}return r}}throw Error("illegal catch attempt")},delegateYield:function(t,n,i){return this.delegate={iterator:L(t),resultName:n,nextLoc:i},"next"===this.method&&(this.arg=e),f}},t}function le(e,t,n,i,r,o,a){try{var s=e[o](a),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(i,r)}function ce(e){return function(){var t=this,n=arguments;return new Promise((function(i,r){var o=e.apply(t,n);function a(e){le(o,i,r,a,s,"next",e)}function s(e){le(o,i,r,a,s,"throw",e)}a(void 0)}))}}function he(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,ue(i.key),i)}}function ue(e){var t=function(e){if("object"!=re(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=re(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==re(t)?t:t+""}var me=function(){return e=function e(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:5;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.game=t,this.parent=n,this.scale=r,this.environmentGroup=new i.YJl,this.parent.add(this.environmentGroup),this.textures={honeycomb:null,honey:null,cells:null},this.hiveElements={honeycombs:null,honeyDrops:null,waxStructures:null},this.particleSystems={},this.energyBeams=[],this.vibeElements=[],this.createEnvironment()},t=[{key:"createEnvironment",value:(r=ce(se().mark((function e(){return se().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.loadTextures();case 2:this.createCylindricalArena(),this.createHiveElements(),this.createHoneyParticles(),this.createVibeElements(),this.createEnergyBeams(),this.createSunlight();case 8:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"loadTextures",value:(n=ce(se().mark((function e(){var t,n;return se().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.game.honeycombTextures||this.game.textureGenerator||this.game.honeycombTextureGenerator){e.next=3;break}return e.abrupt("return");case 3:if(e.prev=3,"function"!=typeof t.getTexture){e.next=17;break}return e.next=7,t.getTexture("honeycomb");case 7:return this.textures.honeycomb=e.sent,e.next=10,t.getTexture("honey");case 10:return this.textures.honey=e.sent,e.next=13,t.getTexture("cells");case 13:this.textures.cells=e.sent,console.log("Successfully loaded textures during initialization"),e.next=25;break;case 17:if("function"!=typeof t.initialize){e.next=24;break}return e.next=20,t.initialize();case 20:n=e.sent,this.textures.honeycomb=n,e.next=25;break;case 24:t.textures&&(t.textures.honeycomb&&(this.textures.honeycomb=t.textures.honeycomb),t.textures.honey&&(this.textures.honey=t.textures.honey),t.textures.cells&&(this.textures.cells=t.textures.cells));case 25:e.next=30;break;case 27:e.prev=27,e.t0=e.catch(3),console.log("Note: Initial texture loading deferred - will be applied when available");case 30:case"end":return e.stop()}}),e,this,[[3,27]])}))),function(){return n.apply(this,arguments)})},{key:"createCylindricalArena",value:function(){var e=400*this.scale,t=300*this.scale,n=new i.Ho_(e,e,t,32,1,!0),r=new i.uSd({color:8965375,metalness:.2,roughness:.05,transparent:!0,opacity:.3,side:i.$EB,transmission:.95,reflectivity:.2,clearcoat:.3});this.wallMaterial=r;var o=new i.eaF(n,r);o.position.set(0,t/2,0),o.name="walls",this.environmentGroup.add(o),this.createPulsingFloor(e,32);var a=new i.tcD(e,32),s=new i._4j({map:this.textures.honeycomb||null,color:65501,side:i.$EB,roughness:.8,metalness:.2});this.ceilingMaterial=s;var l=new i.eaF(a,s);l.rotation.x=Math.PI/2,l.position.set(0,t,0),l.name="ceiling",this.environmentGroup.add(l)}},{key:"createPulsingFloor",value:function(e,t){var n=new i.tcD(e,t),r=new i.BKk({uniforms:{time:{value:0},baseColor:{value:new i.Q1f(56780)},glowColor:{value:new i.Q1f(16763904)},hexScale:{value:20},pulseSpeed:{value:.5}},vertexShader:"\n        varying vec2 vUv;\n        void main() {\n          vUv = uv;\n          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n        }\n      ",fragmentShader:'\n        uniform float time;\n        uniform vec3 baseColor;\n        uniform vec3 glowColor;\n        uniform float hexScale;\n        uniform float pulseSpeed;\n        varying vec2 vUv;\n        \n        // Hex pattern from distance function\n        float hexDist(vec2 p) {\n          p = abs(p);\n          return max(p.x, p.y * 0.866025 + p.x * 0.5);\n        }\n        \n        vec4 hexagon(vec2 p) {\n          vec2 q = vec2(\n            p.x * 2.0 * 0.5773503, \n            p.y + p.x * 0.5773503\n          );\n          \n          vec2 pi = floor(q);\n          vec2 pf = fract(q);\n          \n          float v = mod(pi.x + pi.y, 3.0);\n          \n          float ca = step(1.0, v);\n          float cb = step(2.0, v);\n          vec2 ma = step(pf.xy, pf.yx);\n          \n          // Distance to hex edge\n          float e = dot(ma, 1.0 - pf.yx);\n          \n          // Get final hex shape\n          float dist = hexDist(mod(pf, 1.0) - 0.5);\n          float value = smoothstep(0.45, 0.5, dist);\n          \n          // Add pulsing glow\n          float pulse = sin(time * pulseSpeed + pi.x * 0.3 + pi.y * 0.5) * 0.5 + 0.5;\n          float glow = smoothstep(0.5, 0.45, dist) * pulse;\n          \n          // Vibe pattern - highlight some hexes as "V I B E"\n          float vibe = 0.0;\n          if (mod(pi.x + pi.y * 3.0, 23.0) < 4.0) {\n            vibe = 0.8;\n          }\n          \n          return vec4(value, glow, e, vibe);\n        }\n        \n        void main() {\n          // Scale UV to create hex grid\n          vec2 scaledUv = vUv * hexScale;\n          \n          // Get hex pattern\n          vec4 hex = hexagon(scaledUv);\n          \n          // Base color with hex pattern\n          vec3 color = mix(baseColor, vec3(0.0), hex.x);\n          \n          // Add pulsing glow - mix yellow and teal\n          vec3 glowMix = mix(glowColor, baseColor, sin(time * 0.5) * 0.5 + 0.5);\n          color = mix(color, glowMix, hex.y * 0.5);\n          \n          // Add subtle edge highlights\n          color = mix(color, vec3(1.0), smoothstep(0.9, 1.0, hex.z) * 0.3);\n          \n          // Add vibe highlights\n          if (hex.w > 0.0) {\n            color = mix(color, vec3(0.0, 1.0, 1.0), hex.w * (sin(time * 2.0) * 0.5 + 0.5));\n          }\n          \n          gl_FragColor = vec4(color, 1.0);\n        }\n      ',side:i.$EB}),o=new i.eaF(n,r);o.rotation.x=-Math.PI/2,o.position.set(0,0,0),o.name="floor",o.receiveShadow=!0,this.environmentGroup.add(o),this.pulsatingFloor=o,this.floorMaterial=r}},{key:"createHiveElements",value:function(){this.createHoneycombParticles(),this.createHoneyDropsParticles()}},{key:"createHoneycombParticles",value:function(){for(var e=400*this.scale,t=300*this.scale,n=new i.LoY,r=new Float32Array(3e3),o=new Float32Array(3e3),a=new Float32Array(1e3),s=0;s<1e3;s++){var l=3*s,c=Math.random()*Math.PI*2,h=Math.random()*t,u=.95*e+10*(Math.random()-.5);r[l]=Math.cos(c)*u,r[l+1]=h,r[l+2]=Math.sin(c)*u,Math.random()<.6?(o[l]=.9+.1*Math.random(),o[l+1]=.7+.3*Math.random(),o[l+2]=0+.2*Math.random()):(o[l]=0+.1*Math.random(),o[l+1]=.8+.2*Math.random(),o[l+2]=.8+.2*Math.random()),a[s]=4+6*Math.random()}n.setAttribute("position",new i.THS(r,3)),n.setAttribute("color",new i.THS(o,3)),n.setAttribute("size",new i.THS(a,1));var m=new i.BKk({uniforms:{time:{value:0},pixelRatio:{value:Math.min(window.devicePixelRatio,2)}},vertexShader:"\n        attribute float size;\n        attribute vec3 color;\n        varying vec3 vColor;\n        uniform float time;\n        uniform float pixelRatio;\n        \n        void main() {\n          vColor = color;\n          \n          // Add subtle movement\n          vec3 pos = position;\n          float wobble = sin(time * 0.5 + position.x * 0.1 + position.z * 0.1) * 0.5;\n          pos.y += wobble;\n          \n          vec4 mvPosition = modelViewMatrix * vec4(pos, 1.0);\n          gl_PointSize = size * pixelRatio * (300.0 / -mvPosition.z);\n          gl_Position = projectionMatrix * mvPosition;\n        }\n      ",fragmentShader:"\n        varying vec3 vColor;\n        \n        void main() {\n          // Create a hexagon shape for each particle\n          vec2 coord = gl_PointCoord - vec2(0.5);\n          float len = length(coord);\n          \n          // Sharp hex pattern\n          float a = atan(coord.y, coord.x);\n          float r = 0.5;\n          float d = cos(floor(0.5 + a / (3.1415926 / 3.0)) * (3.1415926 / 3.0) - a) * len / r;\n          \n          if (d > 0.5) {\n            discard;\n          }\n          \n          // Add some glow\n          float alpha = smoothstep(0.5, 0.2, d);\n          gl_FragColor = vec4(vColor, alpha);\n        }\n      ",transparent:!0,depthWrite:!1,blending:i.EZo}),p=new i.ONl(n,m);this.environmentGroup.add(p),this.particleSystems.honeycombs=p}},{key:"createHoneyDropsParticles",value:function(){for(var e=400*this.scale,t=300*this.scale,n=new i.LoY,r=new Float32Array(1500),o=new Float32Array(1500),a=new Float32Array(500),s=new Float32Array(500),l=0;l<500;l++){var c=3*l,h=Math.random()*Math.PI*2,u=Math.random()*e*.8,m=Math.random()*t;r[c]=Math.cos(h)*u,r[c+1]=m,r[c+2]=Math.sin(h)*u,o[c]=.95+.05*Math.random(),o[c+1]=.6+.2*Math.random(),o[c+2]=0+.1*Math.random(),a[l]=2+2*Math.random(),s[l]=.01+.03*Math.random()}n.setAttribute("position",new i.THS(r,3)),n.setAttribute("color",new i.THS(o,3)),n.setAttribute("size",new i.THS(a,1)),n.userData={velocity:s};var p=new i.BKk({uniforms:{time:{value:0},pixelRatio:{value:Math.min(window.devicePixelRatio,2)}},vertexShader:"\n        attribute float size;\n        attribute vec3 color;\n        varying vec3 vColor;\n        uniform float time;\n        uniform float pixelRatio;\n        \n        void main() {\n          vColor = color;\n          vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);\n          gl_PointSize = size * 2.0 * pixelRatio * (300.0 / -mvPosition.z);\n          gl_Position = projectionMatrix * mvPosition;\n        }\n      ",fragmentShader:"\n        varying vec3 vColor;\n        \n        void main() {\n          // Create a drop shape\n          vec2 coord = gl_PointCoord - vec2(0.5);\n          float r = length(coord) * 2.0;\n          \n          // Create droplet shape\n          float alpha = smoothstep(1.0, 0.0, r);\n          \n          // Make bottom part more elongated\n          if (coord.y > 0.0) {\n            alpha *= smoothstep(1.0, 0.0, coord.y * 2.0);\n          }\n          \n          // Add a highlight\n          float highlight = smoothstep(0.5, 0.0, length(coord + vec2(0.2, -0.2)) * 3.0);\n          vec3 color = mix(vColor, vec3(1.0), highlight * 0.5);\n          \n          gl_FragColor = vec4(color, alpha);\n        }\n      ",transparent:!0,depthWrite:!1,blending:i.EZo}),d=new i.ONl(n,p);this.environmentGroup.add(d),this.particleSystems.honeyDrops=d}},{key:"createHoneyParticles",value:function(){for(var e=new i.LoY,t=new Float32Array(6e3),n=new Float32Array(6e3),r=new Float32Array(2e3),o=400*this.scale,a=300*this.scale,s=0;s<2e3;s++){var l=3*s,c=Math.random()*Math.PI*2,h=Math.random()*o*.9,u=Math.random()*a;t[l]=Math.cos(c)*h,t[l+1]=u,t[l+2]=Math.sin(c)*h;var m=Math.random();m<.4?(n[l]=.9+.1*Math.random(),n[l+1]=.7+.2*Math.random(),n[l+2]=0+.1*Math.random()):m<.8?(n[l]=0+.1*Math.random(),n[l+1]=.7+.3*Math.random(),n[l+2]=.7+.3*Math.random()):(n[l]=.8+.2*Math.random(),n[l+1]=.8+.2*Math.random(),n[l+2]=.8+.2*Math.random()),r[s]=.5+1.5*Math.random()}e.setAttribute("position",new i.THS(t,3)),e.setAttribute("color",new i.THS(n,3)),e.setAttribute("size",new i.THS(r,1));var p=new i.BKk({uniforms:{time:{value:0},pixelRatio:{value:Math.min(window.devicePixelRatio,2)}},vertexShader:"\n        attribute float size;\n        attribute vec3 color;\n        varying vec3 vColor;\n        uniform float time;\n        uniform float pixelRatio;\n        \n        void main() {\n          vColor = color;\n          \n          // Add gentle floating motion\n          vec3 pos = position;\n          float timeOffset = position.x * 0.01 + position.z * 0.01;\n          pos.y += sin(time * 0.2 + timeOffset) * 2.0;\n          pos.x += cos(time * 0.1 + position.y * 0.01) * 0.5;\n          pos.z += sin(time * 0.15 + position.y * 0.01) * 0.5;\n          \n          vec4 mvPosition = modelViewMatrix * vec4(pos, 1.0);\n          gl_PointSize = size * pixelRatio * (300.0 / -mvPosition.z);\n          gl_Position = projectionMatrix * mvPosition;\n        }\n      ",fragmentShader:"\n        varying vec3 vColor;\n        \n        void main() {\n          // Soft circular particles\n          float dist = length(gl_PointCoord - 0.5) * 2.0;\n          float alpha = smoothstep(1.0, 0.0, dist);\n          \n          gl_FragColor = vec4(vColor, alpha * 0.6);\n        }\n      ",transparent:!0,depthWrite:!1,blending:i.EZo}),d=new i.ONl(e,p);this.environmentGroup.add(d),this.particleSystems.ambient=d}},{key:"createVibeElements",value:function(){var e=this,t=400*this.scale,n=300*this.scale,r=function(t,n,r){var o=document.createElement("canvas"),a=o.getContext("2d");o.width=512,o.height=128,a.fillStyle="#ffffff",a.font="bold 72px Arial",a.textAlign="center",a.textBaseline="middle",a.fillText(t,o.width/2,o.height/2);for(var s=a.getImageData(0,0,o.width,o.height).data,l=[],c=0;c<o.height;c+=4)for(var h=0;h<o.width;h+=4)if(s[4*(c*o.width+h)]>128){var u=h/o.width*2-1,m=c/o.height*2-1;l.push([u,-m])}for(var p=l.length,d=new i.LoY,y=new Float32Array(3*p),f=new Float32Array(3*p),v=new Float32Array(p),g=0;g<p;g++){var b=3*g,w=oe(l[g],2),x=w[0],S=w[1];y[b]=50*x+n.x,y[b+1]=20*S+n.y,y[b+2]=n.z,f[b]=r.r,f[b+1]=r.g,f[b+2]=r.b,v[g]=1+1.5*Math.random()}d.setAttribute("position",new i.THS(y,3)),d.setAttribute("color",new i.THS(f,3)),d.setAttribute("size",new i.THS(v,1));var k=new i.BKk({uniforms:{time:{value:0},pixelRatio:{value:Math.min(window.devicePixelRatio,2)}},vertexShader:"\n          attribute float size;\n          attribute vec3 color;\n          varying vec3 vColor;\n          uniform float time;\n          uniform float pixelRatio;\n          \n          void main() {\n            vColor = color;\n            \n            // Add wave effect\n            vec3 pos = position;\n            float wave = sin(position.x * 0.1 + time);\n            pos.y += wave * 2.0;\n            \n            vec4 mvPosition = modelViewMatrix * vec4(pos, 1.0);\n            gl_PointSize = size * pixelRatio * (300.0 / -mvPosition.z);\n            gl_Position = projectionMatrix * mvPosition;\n          }\n        ",fragmentShader:"\n          varying vec3 vColor;\n          \n          void main() {\n            float dist = length(gl_PointCoord - 0.5) * 2.0;\n            float alpha = smoothstep(1.0, 0.0, dist);\n            gl_FragColor = vec4(vColor, alpha);\n          }\n        ",transparent:!0,depthWrite:!1,blending:i.EZo}),P=new i.ONl(d,k);return e.environmentGroup.add(P),e.vibeElements.push(P),P};r("#VIBE",new i.Pq0(0,.8*n,0),new i.Q1f(65501)),r("JAM",new i.Pq0(0,.7*n,0),new i.Q1f(16763904));for(var o=0;o<3;o++){var a=this.createVibingRing(.8*t-20*o,.4*n+30*o,o%2==0?56780:16755200);this.vibeElements.push(a)}}},{key:"createVibingRing",value:function(e,t,n){for(var r=new i.LoY,o=new Float32Array(900),a=new Float32Array(900),s=new Float32Array(300),l=new i.Q1f(n),c=0;c<300;c++){var h=3*c,u=c/300*Math.PI*2;o[h]=Math.cos(u)*e,o[h+1]=t,o[h+2]=Math.sin(u)*e,a[h]=l.r,a[h+1]=l.g,a[h+2]=l.b,s[c]=2+2*Math.random()}r.setAttribute("position",new i.THS(o,3)),r.setAttribute("color",new i.THS(a,3)),r.setAttribute("size",new i.THS(s,1));var m=new i.BKk({uniforms:{time:{value:0},pixelRatio:{value:Math.min(window.devicePixelRatio,2)}},vertexShader:"\n        attribute float size;\n        attribute vec3 color;\n        varying vec3 vColor;\n        uniform float time;\n        uniform float pixelRatio;\n        \n        void main() {\n          vColor = color;\n          \n          // Rotate the ring\n          float angle = atan(position.z, position.x) + time * 0.2;\n          float radius = length(position.xz);\n          vec3 pos = position;\n          \n          pos.x = cos(angle) * radius;\n          pos.z = sin(angle) * radius;\n          \n          // Add wave effect\n          pos.y += sin(angle * 8.0 + time) * 5.0;\n          \n          vec4 mvPosition = modelViewMatrix * vec4(pos, 1.0);\n          gl_PointSize = size * pixelRatio * (300.0 / -mvPosition.z);\n          gl_Position = projectionMatrix * mvPosition;\n        }\n      ",fragmentShader:"\n        varying vec3 vColor;\n        \n        void main() {\n          float dist = length(gl_PointCoord - 0.5) * 2.0;\n          float alpha = smoothstep(1.0, 0.0, dist);\n          gl_FragColor = vec4(vColor, alpha);\n        }\n      ",transparent:!0,depthWrite:!1,blending:i.EZo}),p=new i.ONl(r,m);return this.environmentGroup.add(p),p}},{key:"createEnergyBeams",value:function(){for(var e=400*this.scale,t=300*this.scale,n=0;n<5;n++){var r=n/5*Math.PI*2,o=Math.cos(r)*e*.7,a=Math.sin(r)*e*.7,s=new i.Ho_(2,2,t,16,10,!0),l=new i.BKk({uniforms:{time:{value:0},color1:{value:new i.Q1f(65501)},color2:{value:new i.Q1f(16763904)}},vertexShader:"\n          varying vec2 vUv;\n          void main() {\n            vUv = uv;\n            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n          }\n        ",fragmentShader:"\n          uniform float time;\n          uniform vec3 color1;\n          uniform vec3 color2;\n          varying vec2 vUv;\n          \n          void main() {\n            // Create moving waves\n            float wave = sin(vUv.y * 20.0 + time * 2.0) * 0.5 + 0.5;\n            \n            // Vertical gradient\n            float gradient = pow(vUv.y, 0.5);\n            \n            // Edge glow\n            float edge = pow(sin(vUv.x * 6.28318) * 0.5 + 0.5, 2.0);\n            \n            // Combine effects\n            vec3 finalColor = mix(color1, color2, gradient);\n            finalColor *= wave * edge;\n            \n            // Add transparency at edges\n            float alpha = edge * (0.5 + 0.5 * sin(time + vUv.y * 10.0));\n            \n            gl_FragColor = vec4(finalColor, alpha * 0.7);\n          }\n        ",transparent:!0,side:i.$EB,blending:i.EZo}),c=new i.eaF(s,l);c.position.set(o,t/2,a),this.environmentGroup.add(c),this.energyBeams.push(c);var h=new i.tcD(10,32),u=new i.V9B({color:65501,transparent:!0,opacity:.7,side:i.$EB,blending:i.EZo}),m=new i.eaF(h,u);m.rotation.x=-Math.PI/2,m.position.set(o,1,a),this.environmentGroup.add(m)}}},{key:"createSunlight",value:function(){var e=new i.$p8(16772829,.4);this.environmentGroup.add(e);var t=new i.ZyN(16777215,1.6);t.position.set(0,500*this.scale,200*this.scale),t.castShadow=!0,t.shadow.mapSize.width=1024,t.shadow.mapSize.height=1024,t.shadow.camera.near=50*this.scale,t.shadow.camera.far=1e3*this.scale;var n=500*this.scale;t.shadow.camera.left=-n,t.shadow.camera.right=n,t.shadow.camera.top=n,t.shadow.camera.bottom=-n,this.environmentGroup.add(t),this.sunLight=t,this.shadowTarget=new i.B69,this.shadowTarget.position.set(0,0,0),this.environmentGroup.add(this.shadowTarget),t.target=this.shadowTarget;var r=new i.HiM(65501,1,200*this.scale);r.position.set(100*this.scale,150*this.scale,100*this.scale),this.environmentGroup.add(r);var o=new i.HiM(16763904,1,200*this.scale);o.position.set(-100*this.scale,150*this.scale,-100*this.scale),this.environmentGroup.add(o)}},{key:"update",value:function(e){this.game.player&&this.shadowTarget&&(this.shadowTarget.position.copy(this.game.player.position),this.sunLight.target.updateMatrixWorld()),this.updateAnimatedTextures(),this.pulsatingFloor&&this.pulsatingFloor.material.uniforms&&(this.pulsatingFloor.material.uniforms.time.value=.001*performance.now()),this.updateHoneycombParticles(),this.updateHoneyDrops(),this.updateAmbientParticles(),this.updateVibeElements(),this.updateEnergyBeams()}},{key:"updateAnimatedTextures",value:function(){this.floorMaterial&&(this.floorMaterial.needsUpdate=!0),this.ceilingMaterial&&(this.ceilingMaterial.needsUpdate=!0)}},{key:"updateHoneycombParticles",value:function(){if(this.particleSystems.honeycombs){var e=this.particleSystems.honeycombs.material;e&&e.uniforms&&(e.uniforms.time.value=.001*performance.now())}}},{key:"updateHoneyDrops",value:function(){if(this.particleSystems.honeyDrops){var e=this.particleSystems.honeyDrops.material;e&&e.uniforms&&(e.uniforms.time.value=.001*performance.now());for(var t=this.particleSystems.honeyDrops.geometry.attributes.position.array,n=this.particleSystems.honeyDrops.geometry.userData.velocity,i=0;i<n.length;i++){var r=3*i;t[r+1]-=n[i],t[r+1]<0&&(t[r+1]=300*this.scale)}this.particleSystems.honeyDrops.geometry.attributes.position.needsUpdate=!0}}},{key:"updateAmbientParticles",value:function(){if(this.particleSystems.ambient){var e=this.particleSystems.ambient.material;e&&e.uniforms&&(e.uniforms.time.value=.001*performance.now())}}},{key:"updateVibeElements",value:function(){var e=.001*performance.now();this.vibeElements.forEach((function(t){t.material&&t.material.uniforms&&(t.material.uniforms.time.value=e)}))}},{key:"updateEnergyBeams",value:function(){var e=.001*performance.now();this.energyBeams.forEach((function(t){t.material&&t.material.uniforms&&(t.material.uniforms.time.value=e)}))}},{key:"updateTextures",value:function(e,t){t?(console.log("Updating texture for ".concat(e," - animated: ").concat(t.animated?"yes":"no")),e in this.textures&&(this.textures[e]=t),"honeycomb"===e&&this.ceilingMaterial&&(this.ceilingMaterial.map=t,this.ceilingMaterial.needsUpdate=!0),(t.animated||t.source&&t.source.data&&"CANVAS"===t.source.data.tagName)&&(t.needsConstantUpdate=!0)):console.warn("Attempted to update with null texture of type:",e)}},{key:"getColliders",value:function(){var e=[];e.push({type:"plane",position:new i.Pq0(0,0,0),normal:new i.Pq0(0,1,0)}),e.push({type:"plane",position:new i.Pq0(0,300*this.scale,0),normal:new i.Pq0(0,-1,0)});var t=400*this.scale;return e.push({type:"cylinder",position:new i.Pq0(0,150*this.scale,0),radius:t,height:300*this.scale,invertNormals:!0}),e}}],t&&he(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,n,r}();function pe(e){return pe="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},pe(e)}function de(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function ye(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,fe(i.key),i)}}function fe(e){var t=function(e){if("object"!=pe(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=pe(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==pe(t)?t:t+""}var ve=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.game=t,this.scene=t.scene,this.arenaGroup=new i.YJl,this.scene.add(this.arenaGroup),this.textureApplied=!1,this.textureUUID=null,this.bulletManager=new V(t,this.arenaGroup),this.enemyManager=new Z(t,this.arenaGroup),this.environment=new me(t,this.arenaGroup),this.powerUpManager=new ie(t,this.arenaGroup),this.gameStartTime=0,this.gameScore=0,this.killStreak=0,this.killCount=0,this.createScoreDisplay(),this.createHealthIndicator(),this.applyExistingTextures()},(t=[{key:"applyExistingTextures",value:function(){var e=this,t=this.game.honeycombTextures||this.game.textureGenerator;t&&("function"==typeof t.getTexture?Promise.all([t.getTexture("honeycomb"),t.getTexture("fire")]).then((function(t){var n=function(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var i,r,o,a,s=[],l=!0,c=!1;try{if(o=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;l=!1}else for(;!(l=(i=o.call(n)).done)&&(s.push(i.value),s.length!==t);l=!0);}catch(e){c=!0,r=e}finally{try{if(!l&&null!=n.return&&(a=n.return(),Object(a)!==a))return}finally{if(c)throw r}}return s}}(e,t)||function(e,t){if(e){if("string"==typeof e)return de(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?de(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}(t,2),i=n[0],r=n[1];i&&e.updateTexture(i),r&&e.environment.updateTextures("fire",r)})).catch((function(e){console.warn("Could not apply existing textures:",e)})):t.textures&&(t.textures.honeycomb&&this.updateTexture(t.textures.honeycomb),t.textures.fire&&this.environment.updateTextures("fire",t.textures.fire)))}},{key:"updateTexture",value:function(e){return!!e&&(this.textureUUID=e.uuid,this.environment&&(e.name&&e.name.includes("fire")||e.generator&&e.generator.includes("fire")?this.environment.updateTextures("fire",e):this.environment.updateTextures("honeycomb",e),this.textureApplied=!0),!0)}},{key:"createScoreDisplay",value:function(){this.killCount=0,this.killStreak=0}},{key:"addScore",value:function(e){var t=1+.1*this.killStreak,n=Math.round(e*t);this.gameScore+=n,this.killCount++,this.killStreak++,this.showKillNotification(),this.killStreak%10==0&&this.powerUpManager.spawnPowerUp()}},{key:"showScoreText",value:function(e,t){if(this.game.camera&&t){var n=t.clone();n.project(this.game.camera);var i=(.5*n.x+.5)*window.innerWidth,r=-(.5*n.y-.5)*window.innerHeight,o=document.createElement("div");o.textContent=e,o.style.position="absolute",o.style.color="#ffcc00",o.style.fontSize="16px",o.style.fontWeight="bold",o.style.top="".concat(r,"px"),o.style.left="".concat(i,"px"),o.style.textShadow="0 0 3px black",o.style.pointerEvents="none",o.style.zIndex="1000",o.style.transition="all 0.8s ease-out",document.body.appendChild(o),setTimeout((function(){o.style.opacity="0",o.style.transform="translate(0, -30px)",setTimeout((function(){o.parentNode&&document.body.removeChild(o)}),800)}),50)}}},{key:"showKillNotification",value:function(){var e=document.createElement("div");e.style.position="absolute",e.style.top="60%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.backgroundColor="rgba(0, 0, 0, 0.7)",e.style.color="#FFCC00",e.style.padding="10px 20px",e.style.borderRadius="8px",e.style.fontSize="24px",e.style.fontWeight="bold",e.style.textAlign="center",e.style.zIndex="101",e.style.boxShadow="0 0 15px rgba(255, 204, 0, 0.5)",e.style.transition="all 0.5s ease-out";var t="number"==typeof this.killCount?this.killCount:0;this.killStreak>1?e.innerHTML='KILLS: <span style="color:red;">'.concat(t,'</span><br>\n                             <span style="color:#FF5500;">ðŸ”¥ ').concat(this.killStreak," STREAK!</span>"):e.innerHTML='KILLS: <span style="color:red;">'.concat(t,"</span>"),document.body.appendChild(e),setTimeout((function(){e.style.transform="translate(-50%, -150%)",e.style.opacity="0",setTimeout((function(){e.parentNode&&document.body.removeChild(e)}),500)}),1e3)}},{key:"resetStreak",value:function(){this.killStreak=0}},{key:"createHealthIndicator",value:function(){this.healthContainer=document.createElement("div"),this.healthContainer.style.position="absolute",this.healthContainer.style.bottom="20px",this.healthContainer.style.left="50%",this.healthContainer.style.transform="translateX(-50%)",this.healthContainer.style.width="350px",this.healthContainer.style.backgroundColor="rgba(0, 0, 0, 0.7)",this.healthContainer.style.padding="6px 10px",this.healthContainer.style.borderRadius="6px",this.healthContainer.style.boxShadow="0 0 10px rgba(0, 0, 0, 0.5)",this.healthContainer.style.display="none",this.healthContainer.style.zIndex="100";var e=document.createElement("div");e.style.width="100%",e.style.height="12px",e.style.backgroundColor="rgba(255, 255, 255, 0.2)",e.style.borderRadius="4px",e.style.overflow="hidden",e.style.border="1px solid rgba(255, 255, 255, 0.3)",this.healthContainer.appendChild(e),this.healthBar=document.createElement("div"),this.healthBar.style.width="100%",this.healthBar.style.height="100%",this.healthBar.style.backgroundColor="#00ff00",this.healthBar.style.transition="width 0.3s, background-color 0.3s",this.healthBar.style.borderRadius="3px",e.appendChild(this.healthBar),this.healthValue=document.createElement("div"),this.healthValue.textContent="100/100",this.healthValue.style.position="absolute",this.healthValue.style.top="50%",this.healthValue.style.left="50%",this.healthValue.style.transform="translate(-50%, -50%)",this.healthValue.style.color="white",this.healthValue.style.fontSize="12px",this.healthValue.style.fontWeight="bold",this.healthValue.style.textShadow="1px 1px 2px rgba(0, 0, 0, 0.8)",e.appendChild(this.healthValue),document.body.appendChild(this.healthContainer),this.updateHealthIndicator(100)}},{key:"updateHealthIndicator",value:function(e){if(this.healthBar&&this.healthValue){var t=Math.max(0,Math.min(100,e/100*100));if(this.healthBar.style.width="".concat(t,"%"),this.healthBar.style.backgroundColor=t>60?"#00ff00":t>30?"#ffff00":"#ff0000",this.healthValue.textContent="".concat(Math.ceil(e),"/").concat(100),t<20){if(this.healthContainer.style.animation="pulse 1.5s infinite",!document.getElementById("health-pulse-animation")){var n=document.createElement("style");n.id="health-pulse-animation",n.textContent="\n          @keyframes pulse {\n            0% { transform: scale(1); }\n            50% { transform: scale(1.05); }\n            100% { transform: scale(1); }\n          }\n        ",document.head.appendChild(n)}}else this.healthContainer.style.animation="none"}}},{key:"initializeCombat",value:function(){var e=this;if(this.arenaGroup.visible=!0,this.game.collisionSystem){var t=this.environment?this.environment.getColliders():[];this.game.collisionSystem.addColliders(t),this.game.collidersRegistered=!0}this.bulletManager&&this.bulletManager.prewarmSystem(),this.scoreDisplay&&(this.scoreDisplay.style.display="block"),this.healthContainer&&(this.healthContainer.style.display="block"),this.gameStartTime=performance.now(),this.gameScore=0,this.killStreak=0,this.enemyManager?(this.enemyManager.reset(),this.enemyManager.spawnInitialEnemies(5),setTimeout((function(){"function"==typeof e.enemyManager.increaseWaveDifficulty?e.enemyManager.increaseWaveDifficulty():console.warn("Wave system not available on enemyManager")}),2e3)):console.error("Enemy manager not initialized!"),setTimeout((function(){e.powerUpManager&&e.powerUpManager.spawnPowerUp()}),15e3)}},{key:"reset",value:function(){return this.bulletManager&&this.bulletManager.reset(),this.enemyManager&&this.enemyManager.reset(),this.powerUpManager&&this.powerUpManager.reset(),this.gameScore=0,this.killStreak=0,this.killCount=0,this.scoreDisplay&&(this.scoreDisplay.style.display="none"),this.healthContainer&&(this.healthContainer.style.display="none"),!0}},{key:"update",value:function(e){var t=this;this.environment&&this.environment.update(e),this.bulletManager&&this.bulletManager.update((function(e,t){return!1}),this.enemyManager),this.enemyManager&&this.enemyManager.update(e),this.powerUpManager&&this.powerUpManager.update(),void 0!==this.game.playerHealth&&this.healthContainer&&this.updateHealthIndicator(this.game.playerHealth),this.enemyManager&&(this.enemyManager.onEnemyDefeated||(this.enemyManager.onEnemyDefeated=function(){t.addScore(100)}))}}])&&ye(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}();function ge(e){return ge="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ge(e)}function be(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var i,r,o,a,s=[],l=!0,c=!1;try{if(o=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;l=!1}else for(;!(l=(i=o.call(n)).done)&&(s.push(i.value),s.length!==t);l=!0);}catch(e){c=!0,r=e}finally{try{if(!l&&null!=n.return&&(a=n.return(),Object(a)!==a))return}finally{if(c)throw r}}return s}}(e,t)||xe(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function we(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=xe(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0,r=function(){};return{s:r,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==n.return||n.return()}finally{if(s)throw o}}}}function xe(e,t){if(e){if("string"==typeof e)return Se(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Se(e,t):void 0}}function Se(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function ke(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Pe(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ke(Object(n),!0).forEach((function(t){Me(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ke(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Me(e,t,n){return(t=Ee(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Ce(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,Ee(i.key),i)}}function Ee(e){var t=function(e){if("object"!=ge(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=ge(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==ge(t)?t:t+""}var Te=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.game=t,this.colliders=[],this.debugMode=!1,this.debugHelpers=[],this.scene=t?t.scene:null,this.constants={slideFriction:.1,minSlideSpeed:.03,maximumPenetration:.2,responseMultiplier:.9,collisionBuffer:.05}},(t=[{key:"addCollider",value:function(e){if(e.type&&e.position)return e.id||(e.id="collider_"+this.colliders.length),this.colliders.push(e),this.debugMode&&this.createDebugHelper(e),e.id}},{key:"removeCollider",value:function(e){var t=this.colliders.findIndex((function(t){return t.id===e}));if(-1!==t&&(this.colliders.splice(t,1),this.debugMode)){var n=this.debugHelpers.findIndex((function(t){return t.userData.colliderId===e}));if(-1!==n){var i=this.debugHelpers[n];i.parent&&i.parent.remove(i),this.debugHelpers.splice(n,1)}}}},{key:"addColliders",value:function(e){var t=this;Array.isArray(e)&&e.forEach((function(e){if("sphere"===e.type&&void 0!==e.radius)t.addCollider(e);else if("cylinder"===e.type&&void 0!==e.radius){var n=Pe(Pe({},e),{},{height:e.height||140});t.addCollider(n)}else if("plane"===e.type){var r=Pe(Pe({},e),{},{normal:e.normal||new i.Pq0(0,1,0)});t.addCollider(r)}else if("ring"===e.type)t.addCollider(e);else if("platform"===e.type){var o=Pe(Pe({},e),{},{type:"plane",normal:e.normal||new i.Pq0(0,1,0),size:e.radius||10});t.addCollider(o)}else if("ramp"===e.type){t.addCollider(e);var a=(new i.Pq0).subVectors(e.end,e.start).normalize(),s=new i.Pq0(0,1,0);s.cross(new i.Pq0(a.z,0,-a.x));var l={type:"plane",position:(new i.Pq0).addVectors(e.start,e.end).multiplyScalar(.5),normal:s,size:e.width||5};t.addCollider(l)}}))}},{key:"checkCollisions",value:function(e,t){if(!e||!e.position)return!1;var n;if(e.velocity)n=e.velocity;else{if(!e.userData||!e.userData.velocity)return!1;n=e.userData.velocity}if(0===this.colliders.length)return!1;var r,o=!1,a=e.position,s=this.colliders.filter((function(e){return"plane"===e.type&&e.normal&&e.normal.y>.9})),l=we(s);try{for(l.s();!(r=l.n()).done;){var c,h,u=r.value,m=new i.Pq0,p=be(this.planeCollision(a,t,u.position,u.normal),3);c=p[0],m=p[1],h=p[2],c&&(o=!0,this.handleCollisionResponse(e,m,h,n),Math.abs(n.y)<.01&&(a.y+=.01),u.onCollision&&"function"==typeof u.onCollision&&u.onCollision(e))}}catch(e){l.e(e)}finally{l.f()}var d,y=we(this.colliders);try{for(y.s();!(d=y.n()).done;){var f=d.value;if(!s.includes(f)&&!1!==f.active){var v=!1,g=new i.Pq0,b=0;switch(f.type){case"sphere":if(f.invertNormals){var w=a.distanceTo(f.position),x=f.radius-t-1;if(w>x){v=!0;var S=(new i.Pq0).subVectors(a,f.position).normalize();if(g=S.clone().negate(),a.y<5&&g.y<0&&(g.y=0,g.length()>.1?g.normalize():g.set(a.x,0,a.z).normalize()),b=w-x,b*=.1,b=Math.min(b,.5),w>f.radius+20){var k=f.position.clone().add(S.clone().multiplyScalar(.8*x));return k.y=a.y,a.copy(k),n.set(0,0,0),!0}}else v=!1}else{var P=be(this.sphereCollision(a,t,f.position,f.radius),3);v=P[0],g=P[1],b=P[2]}break;case"cylinder":var M=be(this.cylinderCollision(a,t,f.position,f.radius,f.height,f.invertNormals),3);v=M[0],g=M[1],b=M[2];break;case"ring":var C=be(this.ringCollision(a,t,f.position,f.innerRadius,f.outerRadius),3);v=C[0],g=C[1],b=C[2];break;case"plane":var E=be(this.planeCollision(a,t,f.position,f.normal),3);v=E[0],g=E[1],b=E[2];break;case"platform":var T=a.x-f.position.x,A=a.z-f.position.z;if(T*T+A*A<=Math.pow(f.radius,2)){var B=a.y-f.position.y;(B>=0&&B<=1.2*t||B>-.2&&B<.2)&&n.y<=.1&&(v=!0,g=new i.Pq0(0,1,0),(b=t-B)<.1&&(b=.1),b>t&&(b=t))}}v&&(o=!0,this.handleCollisionResponse(e,g,b,n),f.onCollision&&"function"==typeof f.onCollision&&f.onCollision(e))}}}catch(e){y.e(e)}finally{y.f()}return o}},{key:"meshCollision",value:function(e,t,n,r){if(e.distanceTo(n.position)>t+r)return[!1,new i.Pq0,0];var o=(new i.NRn).setFromObject(n),a=new i.Pq0;a.copy(e),o.clampPoint(e,a);var s=(new i.Pq0).subVectors(e,a),l=t-s.length();return l>0?[!0,s.normalize(),l]:[!1,new i.Pq0,0]}},{key:"handleCollisionResponse",value:function(e,t,n,i){var r=e.position;if(r.y<5&&t.y<-.5&&n>1)i.y=Math.max(i.y,1);else{if(n>this.constants.maximumPenetration){var o=Math.min(n-this.constants.maximumPenetration+this.constants.collisionBuffer,1);r.addScaledVector(t,o)}var a=i.dot(t);if(a<0){var s=i.clone().sub(t.clone().multiplyScalar(a));s.multiplyScalar(this.constants.responseMultiplier),s.length()>this.constants.minSlideSpeed&&s.multiplyScalar(1-this.constants.slideFriction),t.y>.7&&(s.y+=.1),i.copy(s)}}}},{key:"sphereCollision",value:function(e,t,n,r){var o=(new i.Pq0).subVectors(e,n),a=o.length(),s=t+r;return a<s?[!0,o.clone().normalize(),s-a]:[!1,new i.Pq0,0]}},{key:"planeCollision",value:function(e,t,n,r){var o=(new i.Pq0).subVectors(e,n).dot(r);return Math.abs(o)<t?[!0,o>0?r.clone():r.clone().negate(),t-Math.abs(o)]:[!1,new i.Pq0,0]}},{key:"cylinderCollision",value:function(e,t,n,r,o,a){var s=n.clone(),l=o/2,c=e.y-(s.y+l),h=s.y-l-e.y;if(c>t||h>t)return[!1,new i.Pq0,0];var u=e.x-s.x,m=e.z-s.z,p=u*u+m*m,d=Math.sqrt(p);if(c<=0&&c>-t&&d<r)return[!0,new i.Pq0(0,1,0),t-Math.abs(c)];if(h<=0&&h>-t&&d<r)return[!0,new i.Pq0(0,-1,0),t-Math.abs(h)];var y=new i.Pq0,f=0,v=!1;return a?d>r-t&&(v=!0,y.set(-u,0,-m),y.normalize(),f=d-(r-t)):d<r+t&&(v=!0,y.set(u,0,m),y.normalize(),f=r+t-d),v?[!0,y,f]:[!1,new i.Pq0,0]}},{key:"ringCollision",value:function(e,t,n,r,o){if(Math.abs(e.y-n.y)>t)return[!1,new i.Pq0,0];var a=e.x-n.x,s=e.z-n.z,l=Math.sqrt(a*a+s*s);if(l<r+t)return[!0,new i.Pq0(a,0,s).normalize(),r+t-l];if(l>o-t){var c=l-(o-t);return[!0,new i.Pq0(a,0,s).normalize().negate(),c]}return[!1,new i.Pq0,0]}},{key:"createDebugHelper",value:function(e){var t,n=new i.V9B({color:16711680,transparent:!0,opacity:.3,wireframe:!0});switch(e.type){case"sphere":(t=new i.eaF(new i.Gu$(e.radius,16,16),n)).position.copy(e.position),e.invertNormals&&(t.material=new i.V9B({color:65280,transparent:!0,opacity:.3,wireframe:!0}));break;case"plane":var r=new i.bdM(100,100);(t=new i.eaF(r,n)).position.copy(e.position),t.lookAt(e.position.clone().add(e.normal));break;case"cylinder":(t=new i.eaF(new i.Ho_(e.radius,e.radius,e.height,32),n)).position.copy(e.position);break;case"ring":var o=new i.ypk;o.absarc(0,0,e.outerRadius,0,2*Math.PI,!1);var a=new i.wAk;a.absarc(0,0,e.innerRadius,0,2*Math.PI,!0),o.holes.push(a);var s=new i.MSw(o);(t=new i.eaF(s,n)).rotation.x=-Math.PI/2,t.position.copy(e.position);break;case"platform":(t=new i.eaF(new i.tcD(e.radius,32),n)).rotation.x=-Math.PI/2,t.position.copy(e.position);break;case"ramp":var l=(new i.Pq0).subVectors(e.end,e.start).length();t=new i.eaF(new i.iNn(e.width||5,.5,l),n);var c=(new i.Pq0).addVectors(e.start,e.end).multiplyScalar(.5);t.position.copy(c);var h=(new i.Pq0).subVectors(e.end,e.start),u=Math.atan2(h.z,h.x);t.rotation.y=-u;var m=e.end.y-e.start.y,p=Math.sqrt(h.x*h.x+h.z*h.z),d=Math.atan2(m,p);t.rotation.x=d}t&&(t.userData.colliderId=e.id,this.game&&this.game.scene?this.game.scene.add(t):this.scene&&this.scene.add(t),this.debugHelpers.push(t))}},{key:"destroy",value:function(){this.debugMode&&this.debugHelpers.forEach((function(e){e.parent&&e.parent.remove(e)})),this.debugHelpers=[],this.colliders=[]}},{key:"reset",value:function(){return this.colliders=[],this.debugHelpers.length>0&&(this.debugHelpers.forEach((function(e){e.parent&&e.parent.remove(e)})),this.debugHelpers=[]),this.collidersRegistered=!1,!0}}])&&Ce(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}();function Ae(e){return Ae="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Ae(e)}function Be(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,Le(i.key),i)}}function Le(e){var t=function(e){if("object"!=Ae(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=Ae(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==Ae(t)?t:t+""}var ze=function(){return e=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.poolSize=t.poolSize||200,this.scene=t.scene,this.geometries={sphere:[new i.Gu$(.05,4,4),new i.Gu$(.1,6,4),new i.Gu$(.2,8,6)],spark:new i.iNn(.3,.3,.3)},this.materials={honey:new i.V9B({color:16763904,transparent:!0,opacity:.7}),explosion:new i.V9B({color:16733440,transparent:!0,opacity:.8}),spark:new i.V9B({color:16755200,transparent:!0,opacity:.9})},this.pools={honey:[],explosion:[],spark:[]},this.initializePools(),this.activeParticles=[]},t=[{key:"initializePools",value:function(){var e=this;Object.keys(this.pools).forEach((function(t){for(var n=0;n<e.poolSize;n++){var r=void 0;if("honey"===t){var o=Math.floor(Math.random()*e.geometries.sphere.length);r=new i.eaF(e.geometries.sphere[o],e.materials.honey.clone())}else if("explosion"===t){var a=Math.floor(Math.random()*e.geometries.sphere.length);r=new i.eaF(e.geometries.sphere[a],e.materials.explosion.clone())}else"spark"===t&&(r=new i.eaF(e.geometries.spark,e.materials.spark.clone()));r.visible=!1,r.userData={active:!1,type:t,velocity:new i.Pq0,acceleration:new i.Pq0,lifetime:0,maxLifetime:0,onUpdate:null},e.scene&&e.scene.add(r),e.pools[t].push(r)}}))}},{key:"getParticle",value:function(e){var t=this.pools[e];if(!t)return null;for(var n=0;n<t.length;n++)if(!t[n].userData.active)return t[n];if(this.activeParticles.length>0){var i=1/0,r=null;if(this.activeParticles.forEach((function(t){t.userData.type===e&&t.userData.lifetime<i&&(i=t.userData.lifetime,r=t)})),r)return r}return null}},{key:"createEffect",value:function(e){for(var t=e.type,n=e.position,r=e.count,o=void 0===r?10:r,a=e.spread,s=void 0===a?.5:a,l=e.velocity,c=void 0===l?.1:l,h=e.acceleration,u=void 0===h?new i.Pq0(0,-.001,0):h,m=e.maxLifetime,p=void 0===m?60:m,d=e.onUpdate,y=void 0===d?null:d,f=e.parent,v=void 0===f?null:f,g=[],b=0;b<o;b++){var w=this.getParticle(t);if(w){w.position.copy(n),s>0&&(w.position.x+=(Math.random()-.5)*s,w.position.y+=(Math.random()-.5)*s,w.position.z+=(Math.random()-.5)*s);var x=new i.Pq0((Math.random()-.5)*c,(Math.random()-.5)*c,(Math.random()-.5)*c);w.visible=!0,w.material.opacity=1,w.userData.active=!0,w.userData.velocity=x,w.userData.acceleration=u.clone(),w.userData.lifetime=0,w.userData.maxLifetime=p+Math.random()*p*.5,w.userData.onUpdate=y,v&&(w.originalParent=w.parent,v.add(w)),this.activeParticles.includes(w)||this.activeParticles.push(w),g.push(w)}}return g}},{key:"createHoneyDrip",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.createEffect({type:"honey",position:e,count:t.count||1,spread:t.spread||.2,velocity:t.velocity||.05,acceleration:new i.Pq0(0,-.002,0),maxLifetime:t.lifetime||120,onUpdate:function(e){var t=e.userData.lifetime/e.userData.maxLifetime;e.scale.y=1+t,t>.7&&(e.material.opacity=1*(1-(t-.7)/.3))}})}},{key:"createExplosion",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.createEffect({type:"explosion",position:e,count:t.count||15,spread:t.spread||.5,velocity:t.velocity||.2,maxLifetime:t.lifetime||60,onUpdate:function(e){var t=e.userData.lifetime/e.userData.maxLifetime;e.material.opacity=1*(1-t),e.userData.velocity.multiplyScalar(.98)}})}},{key:"createTrailEffect",value:function(e){for(var t=e.type,n=void 0===t?"spark":t,r=e.position,o=e.count,a=void 0===o?3:o,s=e.color,l=void 0===s?new i.Q1f(16777130):s,c=e.spread,h=void 0===c?.2:c,u=e.velocity,m=void 0===u?.05:u,p=e.maxLifetime,d=void 0===p?15:p,y=e.onUpdate,f=void 0===y?null:y,v=this.game&&this.game.isMobile?Math.max(1,Math.floor(a/2)):a,g=[],b=0;b<v;b++){var w=this.getParticle(n);if(w){w.position.copy(r),h>0&&(w.position.x+=(Math.random()-.5)*h,w.position.y+=(Math.random()-.5)*h,w.position.z+=(Math.random()-.5)*h);var x=new i.Pq0((Math.random()-.5)*m,(Math.random()-.5)*m*.5,(Math.random()-.5)*m);w.visible=!0,w.material.opacity=.7,l&&w.material.color.copy(l),w.userData.active=!0,w.userData.velocity=x,w.userData.acceleration=new i.Pq0(0,-5e-4,0),w.userData.lifetime=0,w.userData.maxLifetime=d+5*Math.random(),w.userData.onUpdate=f,this.activeParticles.includes(w)||this.activeParticles.push(w),g.push(w)}}return g}},{key:"update",value:function(){if(0!==this.activeParticles.length){for(var e=this.game&&this.game.isMobile?20:50,t=this.lastProcessedIndex||0,n=Math.min(t+e,this.activeParticles.length),i=n-1;i>=t;i--){var r=this.activeParticles[i],o=r.userData;r.position.add(o.velocity),o.velocity.add(o.acceleration),o.lifetime++,o.onUpdate&&o.onUpdate(r),o.lifetime>o.maxLifetime&&(this.recycleParticle(r),this.activeParticles.splice(i,1))}this.lastProcessedIndex=n>=this.activeParticles.length?0:n}}},{key:"recycleParticle",value:function(e){e.visible=!1,e.userData.active=!1,e.userData.lifetime=0,e.userData.onUpdate=null,e.scale.set(1,1,1),e.originalParent&&e.parent!==e.originalParent&&(e.parent.remove(e),e.originalParent&&e.originalParent.add(e))}},{key:"prewarm",value:function(){var e=this,t=new i.Pq0;Object.keys(this.pools).forEach((function(n){for(var i=0;i<10;i++)e.createEffect({type:n,position:t,count:5}).forEach((function(t){return e.recycleParticle(t)}))})),this.activeParticles=[]}},{key:"dispose",value:function(){var e=this;this.activeParticles.forEach((function(t){return e.recycleParticle(t)})),this.activeParticles=[],this.scene&&Object.values(this.pools).flat().forEach((function(t){e.scene.remove(t)})),Object.keys(this.geometries).forEach((function(t){Array.isArray(e.geometries[t])?e.geometries[t].forEach((function(e){return e.dispose()})):e.geometries[t].dispose()})),Object.values(this.materials).forEach((function(e){return e.dispose()})),this.pools={}}}],t&&Be(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}();function Ie(e){return Ie="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Ie(e)}function Oe(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,je(i.key),i)}}function je(e){var t=function(e){if("object"!=Ie(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=Ie(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==Ie(t)?t:t+""}var De=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.game=t,this.scene=t.scene,this.currentZone="exterior",this.transitionProgress=0,this.exteriorSkybox=null,this.interiorHive=null,this.game.assetManager&&this.game.assetManager.isLoaded()?(this.exteriorSkybox=this.game.assetManager.getTexture("forestSkybox"),this.interiorHive=this.game.assetManager.getTexture("spaceSkybox"),this.updateEnvironment()):(this.loadExteriorSkybox(),this.loadHiveHDRI())},t=[{key:"loadExteriorSkybox",value:function(){var e=this;(new i.Tap).load("assets/textures/forest_mid.png",(function(t){t.mapping=i.wfO,t.colorSpace=i.er$,e.exteriorSkybox=t,e.updateEnvironment()}))}},{key:"loadHiveHDRI",value:function(){var e=this;(new i.Tap).load("assets/textures/space_hdri.jpg",(function(t){t.mapping=i.wfO,t.colorSpace=i.er$,e.interiorHive=t,e.updateEnvironment()}))}},{key:"updateEnvironment",value:function(){"exterior"===this.currentZone&&this.exteriorSkybox?(this.game.scene.background=this.exteriorSkybox,this.updateLighting("exterior"),this.game.combatArena&&(this.game.combatArena.arenaGroup.visible=!1)):"interior"===this.currentZone&&this.interiorHive&&(this.game.scene.background=this.interiorHive,this.updateLighting("interior"),this.game.combatArena&&(this.game.combatArena.arenaGroup.visible=!0,this.game.inCombat||(this.game.combatArena.initializeCombat(),this.game.inCombat=!0)))}},{key:"updateLighting",value:function(e){this.game.scene.traverse((function(t){t.isLight&&t.userData.environmentLight&&("exterior"===e?(t.intensity=t.userData.exteriorIntensity||1,t.color.set(t.userData.exteriorColor||16777215)):"interior"===e&&(t.intensity=t.userData.interiorIntensity||.7,t.color.set(t.userData.interiorColor||16759671)))}))}},{key:"updateZone",value:function(e){var t=e.length();t<15?"interior"!==this.currentZone&&(this.currentZone="interior","interior"!==this.game.currentEnvironment&&this.game.switchEnvironment("interior"),this.updateEnvironment()):t>20&&"exterior"!==this.currentZone&&(this.currentZone="exterior",this.updateEnvironment())}},{key:"update",value:function(e){if("transition"===this.currentZone)if(this.transitionProgress+=.001*e,this.transitionProgress>=1)this.currentZone="interior",this.updateEnvironment(),"interior"!==this.game.currentEnvironment&&this.game.switchEnvironment("interior");else{var t=this.transitionProgress,n=1-t,i=t;this.blendEnvironments(n,i)}}},{key:"blendEnvironments",value:function(e,t){if(this.game.scene.fog){var n=new i.Q1f(8900331),r=new i.Q1f(13016173),o=(new i.Q1f).copy(n).multiplyScalar(e).add(r.clone().multiplyScalar(t));this.game.scene.fog.color.copy(o),this.game.scene.fog.density=.001*e+.002*t}this.blendLighting(e,t)}},{key:"blendLighting",value:function(e,t){this.game.scene.traverse((function(n){if(n.isLight&&n.userData.environmentLight){var r=n.userData.exteriorIntensity||1,o=n.userData.interiorIntensity||.7,a=new i.Q1f(n.userData.exteriorColor||16777215),s=new i.Q1f(n.userData.interiorColor||16759671);n.intensity=r*e+o*t,n.color.copy(a).multiplyScalar(e).add(s.clone().multiplyScalar(t))}}))}}],t&&Oe(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}();function Fe(e){return Fe="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Fe(e)}function Ge(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,He(i.key),i)}}function He(e){var t=function(e){if("object"!=Fe(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=Fe(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==Fe(t)?t:t+""}var qe=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.game=t,this.scene=t.scene,this.player=t.player,this.exitPortalGroup=null,this.startPortalGroup=null,this.exitPortalBox=null,this.startPortalBox=null,this.checkPortalEntry(),this.createExitPortal(),this.updatePortalVisibility()},(t=[{key:"checkPortalEntry",value:function(){"true"===new URLSearchParams(window.location.search).get("portal")&&(this.createStartPortal(),this.game.player&&(this.game.player.position.set(100,50,100),this.game.camera.position.set(100,55,120)))}},{key:"createStartPortal",value:function(){this.startPortalGroup=new i.YJl,this.startPortalGroup.position.set(100,50,100);var e=new i.O3Y(15,2,16,100),t=new i.tXL({color:16711680,emissive:16711680,transparent:!0,opacity:.8}),n=new i.eaF(e,t);this.startPortalGroup.add(n);var r=new i.tcD(13,32),o=new i.V9B({color:16711680,transparent:!0,opacity:.5,side:i.$EB}),a=new i.eaF(r,o);this.startPortalGroup.add(a),this.createPortalParticles(this.startPortalGroup,16711680),this.startPortalBox=(new i.NRn).setFromObject(this.startPortalGroup),this.scene.add(this.startPortalGroup),this.animatePortal(this.startPortalGroup)}},{key:"createExitPortal",value:function(){this.exitPortalGroup=new i.YJl,this.exitPortalGroup.position.set(300,150,-300);var e=new i.O3Y(15,2,16,100),t=new i.tXL({color:65280,emissive:65280,transparent:!0,opacity:.8}),n=new i.eaF(e,t);this.exitPortalGroup.add(n);var r=new i.tcD(13,32),o=new i.V9B({color:65280,transparent:!0,opacity:.5,side:i.$EB}),a=new i.eaF(r,o);this.exitPortalGroup.add(a),this.createPortalLabel(this.exitPortalGroup),this.createPortalParticles(this.exitPortalGroup,65280),this.exitPortalBox=(new i.NRn).setFromObject(this.exitPortalGroup),this.scene.add(this.exitPortalGroup),this.animatePortal(this.exitPortalGroup),this.exitPortalGroup&&(this.exitPortalGroup.visible=!1)}},{key:"updatePortalVisibility",value:function(){if(this.game){var e="interior"===this.game.currentEnvironment;this.exitPortalGroup&&(this.exitPortalGroup.visible=e)}}},{key:"createPortalLabel",value:function(e){var t=document.createElement("canvas"),n=t.getContext("2d");t.width=512,t.height=64,n.fillStyle="#00ff00",n.font="bold 32px Arial",n.textAlign="center",n.fillText("VIBEVERSE PORTAL",t.width/2,t.height/2);var r=new i.GOR(t),o=new i.bdM(30,5),a=new i.V9B({map:r,transparent:!0,side:i.$EB}),s=new i.eaF(o,a);s.position.y=20,e.add(s)}},{key:"createPortalParticles",value:function(e,t){var n=0,r=0,o=0;16711680===t?(n=1,r=0,o=0):(n=0,r=1,o=0);for(var a=new i.LoY,s=new Float32Array(3e3),l=new Float32Array(3e3),c=0;c<3e3;c+=3){var h=Math.random()*Math.PI*2,u=15+4*(Math.random()-.5);s[c]=Math.cos(h)*u,s[c+1]=Math.sin(h)*u,s[c+2]=4*(Math.random()-.5),l[c]=n*(.8+.2*Math.random()),l[c+1]=r*(.8+.2*Math.random()),l[c+2]=o*(.8+.2*Math.random())}a.setAttribute("position",new i.THS(s,3)),a.setAttribute("color",new i.THS(l,3));var m=new i.BH$({size:.2,vertexColors:!0,transparent:!0,opacity:.6}),p=new i.ONl(a,m);e.userData.particles=p,e.add(p)}},{key:"animatePortal",value:function(e){var t=this;if(e&&e.userData.particles){var n=function(){if(t.game&&"paused"!==t.game.gameState){for(var i=e.userData.particles.geometry.attributes.position.array,r=0;r<i.length;r+=3)i[r+1]+=.05*Math.sin(.001*Date.now()+r);e.userData.particles.geometry.attributes.position.needsUpdate=!0,requestAnimationFrame(n)}else requestAnimationFrame(n)};n()}}},{key:"update",value:function(){if("playing"===this.game.gameState&&(this.updatePortalVisibility(),this.game.player)){var e=this.game.player.position.clone(),t=new i.NRn;if(t.setFromCenterAndSize(e,new i.Pq0(5,5,5)),this.exitPortalBox&&"interior"===this.game.currentEnvironment){this.exitPortalBox.setFromObject(this.exitPortalGroup);var n=new i.Pq0;this.exitPortalBox.getCenter(n),e.distanceTo(n)<50&&t.intersectsBox(this.exitPortalBox)&&this.handleExitPortal()}if(this.startPortalBox&&this.startPortalGroup){this.startPortalBox.setFromObject(this.startPortalGroup);var r=new i.Pq0;this.startPortalBox.getCenter(r),e.distanceTo(r)<50&&t.intersectsBox(this.startPortalBox)&&this.handleStartPortal()}}}},{key:"handleExitPortal",value:function(){var e=new URLSearchParams;e.append("portal","true"),e.append("username","BeePilot"),e.append("color","yellow");var t=.5;if(this.game.player&&(this.game.player.currentProfile&&this.game.player.currentProfile.maxSpeed?t=this.game.player.currentProfile.maxSpeed:this.game.player.maxSpeed?t=this.game.player.maxSpeed:this.game.player.userData&&this.game.player.userData.speed&&(t=this.game.player.userData.speed)),e.append("speed",t),e.append("ref",window.location.href),this.game.player&&this.game.player.velocity&&(e.append("speed_x",this.game.player.velocity.x||0),e.append("speed_y",this.game.player.velocity.y||0),e.append("speed_z",this.game.player.velocity.z||0),this.game.player.quaternion)){var n=(new i.O9p).setFromQuaternion(this.game.player.quaternion);e.append("rotation_x",n.x),e.append("rotation_y",n.y),e.append("rotation_z",n.z)}window.location.href="http://portal.pieter.com?".concat(e.toString())}},{key:"handleStartPortal",value:function(){console.log("Player entered start portal")}}])&&Ge(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}();function Re(e){return Re="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Re(e)}function Ue(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,Ve(i.key),i)}}function Ve(e){var t=function(e){if("object"!=Re(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=Re(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==Re(t)?t:t+""}var _e=function(){return e=function e(t){var n=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.game=t,this.isMobile=this.detectMobile(),this.elements={},this.touchIds={joystick:null,look:null},this.buttonSize=60,this.createControls(),document.addEventListener("fullscreenchange",(function(){return n.updateFullscreenButton()})),document.addEventListener("webkitfullscreenchange",(function(){return n.updateFullscreenButton()})),document.addEventListener("mozfullscreenchange",(function(){return n.updateFullscreenButton()})),document.addEventListener("MSFullscreenChange",(function(){return n.updateFullscreenButton()}))},t=[{key:"detectMobile",value:function(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||"ontouchstart"in window||navigator.maxTouchPoints>0}},{key:"createSensitivitySlider",value:function(){var e=this;if(this.isMobile&&this.game.player){var t=document.createElement("div");t.style.cssText="position:fixed;bottom:50%;left:50%;transform:translate(-50%,50%);background:rgba(0,0,0,0.3);padding:15px;border-radius:10px;z-index:1500;width:70%;max-width:300px;text-align:center;";var n=document.createElement("input");n.type="range",n.min="1",n.max="10",n.step="0.1",n.value=this.game.player.mouseSensitivity||"2.0",n.style.cssText="width:100%;height:25px;",t.appendChild(n),n.addEventListener("input",(function(){var t=parseFloat(n.value);e.game.player&&(e.game.player.mouseSensitivity=t)})),document.body.appendChild(t),this.elements.sensitivityContainer=t}}},{key:"removeSensitivityContainer",value:function(){this.elements.sensitivityContainer&&this.elements.sensitivityContainer.parentNode&&(this.elements.sensitivityContainer.parentNode.removeChild(this.elements.sensitivityContainer),delete this.elements.sensitivityContainer)}},{key:"findSensitivitySlider",value:function(){var e,t=document.querySelector(".pause-screen")||document.getElementById("pauseScreen")||document.querySelector('[class*="pause"]');return t?t.querySelector('input[type="range"]')||(null===(e=Array.from(t.querySelectorAll("div")).find((function(e){return e.textContent.toLowerCase().includes("sensitivity")})))||void 0===e?void 0:e.querySelector("input")):null}},{key:"setupResumeListener",value:function(){var e=this;this.resumeListener&&document.removeEventListener("keydown",this.resumeListener),this.resumeListener=function(t){"Escape"===t.key&&"paused"===e.game.gameState&&setTimeout((function(){return e.removeSensitivityContainer()}),50)},document.addEventListener("keydown",this.resumeListener),this.stateCheckInterval||(this.stateCheckInterval=setInterval((function(){e.originalPauseState&&"playing"===e.game.gameState&&(e.removeSensitivityContainer(),e.originalPauseState=!1)}),100))}},{key:"createControls",value:function(){var e=this,t=document.createElement("div");t.style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:1000;",document.body.appendChild(t),this.elements.container=t,this.isMobile&&(this.createTopBarControls(),this.createJoystick(),this.createFireButton(),this.createLookArea()),window.addEventListener("resize",(function(){return e.handleResize()})),this.isMobile&&this.positionElements(),this.hideControls()}},{key:"createTopBarControls",value:function(){var e=this,t=document.createElement("button");t.innerHTML="ðŸ”Š",t.style.cssText="position:fixed;left:10px;top:10px;background:rgba(0,0,0,0.3);color:white;border:none;border-radius:5px;padding:8px;font-size:18px;z-index:1001;pointer-events:auto;",t.addEventListener("click",(function(){if(e.game.soundManager){var n=e.game.soundManager.toggleMute();t.innerHTML=n?"ðŸ”‡":"ðŸ”Š"}})),document.body.appendChild(t),this.elements.volume=t;var n=document.createElement("button");n.textContent="PAUSE",n.style.cssText="position:fixed;top:10px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.3);color:white;border:none;border-radius:5px;padding:3px 16px;font-size:14px;z-index:1001;pointer-events:auto;line-height:1.2;",n.addEventListener("click",(function(){e.game.togglePause&&e.game.togglePause()})),document.body.appendChild(n),this.elements.pause=n;var i=document.createElement("button");i.innerHTML="â›¶",i.style.cssText="position:fixed;right:10px;top:10px;background:rgba(0,0,0,0.3);color:white;border:none;border-radius:5px;padding:8px;font-size:18px;z-index:1001;pointer-events:auto;",i.addEventListener("click",(function(){return e.toggleFullscreen()})),document.body.appendChild(i),this.elements.fullscreen=i}},{key:"createJoystick",value:function(){var e=this,t=document.createElement("div");t.style.cssText="position:absolute;border-radius:50%;background:rgba(255,255,255,0.2);border:2px solid rgba(255,255,255,0.5);pointer-events:auto;",this.elements.container.appendChild(t);var n=document.createElement("div");n.style.cssText="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);border-radius:50%;background:rgba(255,255,255,0.8);pointer-events:none;",t.appendChild(n),this.elements.joystick=t,this.elements.knob=n,t.addEventListener("touchstart",(function(n){if(n.preventDefault(),null===e.touchIds.joystick){var i=n.changedTouches[0];e.touchIds.joystick=i.identifier;var r=t.getBoundingClientRect();e.joystickCenter={x:r.left+r.width/2,y:r.top+r.height/2},e.processJoystickMovement(i.clientX,i.clientY)}})),t.addEventListener("touchmove",(function(t){t.preventDefault();for(var n=0;n<t.changedTouches.length;n++){var i=t.changedTouches[n];if(i.identifier===e.touchIds.joystick){e.processJoystickMovement(i.clientX,i.clientY);break}}}),{passive:!1});var i=function(t){for(var n=0;n<t.changedTouches.length;n++)if(t.changedTouches[n].identifier===e.touchIds.joystick){e.elements.knob.style.transform="translate(-50%, -50%)",e.game&&e.game.player&&(e.game.player.moveUp=!1,e.game.player.brake=!1,e.game.player.moveLeft=!1,e.game.player.accelarate=!1),e.touchIds.joystick=null;break}};t.addEventListener("touchend",i),t.addEventListener("touchcancel",i)}},{key:"createFireButton",value:function(){var e=this,t=document.createElement("button");t.textContent="FIRE",t.style.cssText="position:absolute;border-radius:50%;background:rgba(255,60,60,0.7);color:white;font-weight:bold;border:2px solid rgba(255,255,255,0.5);pointer-events:auto;display:flex;align-items:center;justify-content:center;outline:none;cursor:pointer;user-select:none;-webkit-tap-highlight-color:transparent;opacity:0.8;",this.elements.container.appendChild(t),this.elements.fireBtn=t,t.style.right="20px",t.style.bottom="100px",t.addEventListener("touchstart",(function(n){n.preventDefault(),n.stopPropagation(),t.style.transform="scale(0.95)",t.style.backgroundColor="rgba(255,0,0,0.9)",e.game&&(e.game.inCombat=!0,e.game.currentEnvironment="interior",e.game.playerShoot())}),{passive:!1});var n=function(){t.style.transform="scale(1)",t.style.backgroundColor="rgba(255,60,60,0.7)"};t.addEventListener("touchend",n),t.addEventListener("touchcancel",n)}},{key:"createLookArea",value:function(){var e=this,t=document.createElement("div");t.style.cssText="position:absolute;top:0;right:0;width:50%;height:100%;pointer-events:auto;",this.elements.container.appendChild(t),this.elements.lookArea=t,this.lookPosition={x:0,y:0},this.lookActive=!1;var n=0,i=0;t.addEventListener("touchstart",(function(t){if(null===e.touchIds.look){var r=t.changedTouches[0];e.touchIds.look=r.identifier,n=r.clientX,i=r.clientY,e.lookPosition={x:n,y:i},e.lookActive=!0,e.updateFireButtonPosition(),e.elements.fireBtn&&(e.elements.fireBtn.style.width="".concat(.8*e.buttonSize,"px"),e.elements.fireBtn.style.height="".concat(.8*e.buttonSize,"px"),e.elements.fireBtn.style.opacity="1.0",e.elements.fireBtn.style.visibility="visible")}})),t.addEventListener("touchmove",(function(t){if(null!==e.touchIds.look)for(var r=0;r<t.changedTouches.length;r++){var o=t.changedTouches[r];if(o.identifier===e.touchIds.look){var a=o.clientX-n,s=o.clientY-i;e.game.player&&"function"==typeof e.game.player.handleMouseMove&&e.game.player.handleMouseMove(.8*a,.8*s),n=o.clientX,i=o.clientY,e.lookPosition={x:n,y:i},e.updateFireButtonPosition();break}}}));var r=function(t){for(var n=0;n<t.changedTouches.length;n++)if(t.changedTouches[n].identifier===e.touchIds.look){e.touchIds.look=null,e.lookActive=!1,setTimeout((function(){!e.lookActive&&e.elements.fireBtn&&(e.elements.fireBtn.style.opacity="0.4")}),800);break}};t.addEventListener("touchend",r),t.addEventListener("touchcancel",r)}},{key:"updateFireButtonPosition",value:function(){if(this.lookActive&&this.elements.fireBtn){var e=this.elements.fireBtn,t=.8*this.buttonSize,n=this.lookPosition.x+20,i=this.lookPosition.y+20,r=window.innerWidth-t,o=window.innerHeight-t;n=Math.min(Math.max(0,n),r),i=Math.min(Math.max(0,i),o),e.style.position="absolute",e.style.left="".concat(n,"px"),e.style.top="".concat(i,"px"),e.style.right="auto",e.style.bottom="auto"}}},{key:"processJoystickMovement",value:function(e,t){if(this.joystickCenter){var n=e-this.joystickCenter.x,i=t-this.joystickCenter.y,r=Math.sqrt(n*n+i*i),o=this.elements.joystick.offsetWidth/2,a=Math.min(r,o),s=Math.atan2(i,n),l=a/o,c=a*Math.cos(s),h=a*Math.sin(s);if(this.elements.knob.style.transform="translate(calc(-50% + ".concat(c,"px), calc(-50% + ").concat(h,"px))"),this.game.player.accelerate=!1,this.game.player.brake=!1,this.game.player.moveLeft=!1,this.game.player.moveRight=!1,l>.2){var u=(s+2*Math.PI)%(2*Math.PI);(u<=Math.PI/4||u>7*Math.PI/4)&&(this.game.player.moveRight=!0),u>Math.PI/4&&u<=3*Math.PI/4&&(this.game.player.brake=!0),u>3*Math.PI/4&&u<=5*Math.PI/4&&(this.game.player.moveLeft=!0),u>5*Math.PI/4&&u<=7*Math.PI/4&&(this.game.player.accelerate=!0)}}}},{key:"checkPauseState",value:function(){var e=this;if(this.game){var t="paused"===this.game.gameState;t!==this.originalPauseState&&(this.originalPauseState=t,t&&setTimeout((function(){var t=e.findSensitivitySlider();t?e.enhanceMobileSensitivitySlider(t):e.createSensitivitySlider()}),100))}}},{key:"enhanceMobileSensitivitySlider",value:function(e){e.style.height="30px",e.style.width="80%";var t=e.closest("div");t&&(t.style.background="rgba(0, 0, 0, 0.7)",t.style.padding="20px",t.style.borderRadius="10px")}},{key:"positionElements",value:function(){if(this.isMobile&&this.elements){var e=window.innerWidth,t=window.innerHeight,n=.03*Math.min(e,t);this.buttonSize=Math.min(.22*t,.1*e);var i=this.buttonSize;if(this.elements.joystick&&this.elements.joystick.style){var r=this.elements.joystick,o=1.3*i;if(r.style.width="".concat(o,"px"),r.style.height="".concat(o,"px"),r.style.bottom="".concat(.25*t,"px"),r.style.left="".concat(6*n,"px"),this.elements.knob&&this.elements.knob.style){var a=this.elements.knob;a.style.width="".concat(.4*o,"px"),a.style.height="".concat(.4*o,"px")}}if(this.elements.fireBtn&&this.elements.fireBtn.style){var s=this.elements.fireBtn;s.style.width="".concat(i,"px"),s.style.height="".concat(i,"px"),s.style.fontSize="".concat(.2*i,"px"),s.style.zIndex="1100"}this.elements.volume&&this.elements.volume.style&&(this.elements.volume.style.left="10px",this.elements.volume.style.top="10px"),this.elements.pause&&this.elements.pause.style&&(this.elements.pause.style.top="10px"),this.elements.fullscreen&&this.elements.fullscreen.style&&(this.elements.fullscreen.style.right="10px",this.elements.fullscreen.style.top="10px"),this.elements.lookArea&&this.elements.lookArea.style&&(this.elements.lookArea.style.width="50%",this.elements.lookArea.style.height="100%")}}},{key:"handleResize",value:function(){this.positionElements()}},{key:"toggleFullscreen",value:function(){if(document.fullscreenElement){var e=document.exitFullscreen||document.mozCancelFullScreen||document.webkitExitFullscreen||document.msExitFullscreen;e&&e.call(document)}else{var t=document.documentElement,n=t.requestFullscreen||t.mozRequestFullScreen||t.webkitRequestFullscreen||t.msRequestFullscreen;n&&n.call(t)}}},{key:"updateFullscreenButton",value:function(){var e=!!document.fullscreenElement;this.elements.fullscreen&&(this.elements.fullscreen.style.display=e?"none":"block")}},{key:"showControls",value:function(){var e=this;this.isMobile?this.game&&!0===this.game.forceDesktopControls?console.log("Desktop controls forced by game settings"):(this.elements.container&&(this.elements.container.style.display="block"),Object.keys(this.elements).forEach((function(t){var n=e.elements[t];n&&n.style&&("fullscreen"===t?n.style.display=document.fullscreenElement?"none":"block":"sensitivityContainer"===t?n.style.display=e.game&&"paused"===e.game.gameState?"block":"none":"container"!==t&&(n.style.display="block"))})),console.log("Mobile controls shown")):console.log("Not showing mobile controls on desktop device")}},{key:"showSensitivityControls",value:function(e){if(this.isMobile&&(this.removeSensitivityContainer(),!1!==e)){var t=document.querySelector("#vibejam-overlay")||document.querySelector(".game-screen")||document.querySelector('[class*="pause"]');t&&Array.from(t.querySelectorAll("div")).filter((function(e){return e.textContent&&e.textContent.includes("Mouse Sensitivity")})).forEach((function(e){e&&e.style&&(e.style.display="none")})),this.createSensitivitySlider(),this.originalPauseState="paused"===this.game.gameState,this.setupResumeListener()}}},{key:"hideControls",value:function(){this.isMobile&&(this.elements.container.style.display="none",Object.values(this.elements).forEach((function(e){e&&e.style&&(e.style.display="none")})),this.removeSensitivityContainer(),this.stateCheckInterval&&(clearInterval(this.stateCheckInterval),this.stateCheckInterval=null),this.resumeListener&&(document.removeEventListener("keydown",this.resumeListener),this.resumeListener=null))}}],t&&Ue(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}();function Ne(e){return Ne="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Ne(e)}function We(){We=function(){return t};var e,t={},n=Object.prototype,i=n.hasOwnProperty,r=Object.defineProperty||function(e,t,n){e[t]=n.value},o="function"==typeof Symbol?Symbol:{},a=o.iterator||"@@iterator",s=o.asyncIterator||"@@asyncIterator",l=o.toStringTag||"@@toStringTag";function c(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(e){c=function(e,t,n){return e[t]=n}}function h(e,t,n,i){var o=t&&t.prototype instanceof v?t:v,a=Object.create(o.prototype),s=new B(i||[]);return r(a,"_invoke",{value:C(e,n,s)}),a}function u(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=h;var m="suspendedStart",p="suspendedYield",d="executing",y="completed",f={};function v(){}function g(){}function b(){}var w={};c(w,a,(function(){return this}));var x=Object.getPrototypeOf,S=x&&x(x(L([])));S&&S!==n&&i.call(S,a)&&(w=S);var k=b.prototype=v.prototype=Object.create(w);function P(e){["next","throw","return"].forEach((function(t){c(e,t,(function(e){return this._invoke(t,e)}))}))}function M(e,t){function n(r,o,a,s){var l=u(e[r],e,o);if("throw"!==l.type){var c=l.arg,h=c.value;return h&&"object"==Ne(h)&&i.call(h,"__await")?t.resolve(h.__await).then((function(e){n("next",e,a,s)}),(function(e){n("throw",e,a,s)})):t.resolve(h).then((function(e){c.value=e,a(c)}),(function(e){return n("throw",e,a,s)}))}s(l.arg)}var o;r(this,"_invoke",{value:function(e,i){function r(){return new t((function(t,r){n(e,i,t,r)}))}return o=o?o.then(r,r):r()}})}function C(t,n,i){var r=m;return function(o,a){if(r===d)throw Error("Generator is already running");if(r===y){if("throw"===o)throw a;return{value:e,done:!0}}for(i.method=o,i.arg=a;;){var s=i.delegate;if(s){var l=E(s,i);if(l){if(l===f)continue;return l}}if("next"===i.method)i.sent=i._sent=i.arg;else if("throw"===i.method){if(r===m)throw r=y,i.arg;i.dispatchException(i.arg)}else"return"===i.method&&i.abrupt("return",i.arg);r=d;var c=u(t,n,i);if("normal"===c.type){if(r=i.done?y:p,c.arg===f)continue;return{value:c.arg,done:i.done}}"throw"===c.type&&(r=y,i.method="throw",i.arg=c.arg)}}}function E(t,n){var i=n.method,r=t.iterator[i];if(r===e)return n.delegate=null,"throw"===i&&t.iterator.return&&(n.method="return",n.arg=e,E(t,n),"throw"===n.method)||"return"!==i&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+i+"' method")),f;var o=u(r,t.iterator,n.arg);if("throw"===o.type)return n.method="throw",n.arg=o.arg,n.delegate=null,f;var a=o.arg;return a?a.done?(n[t.resultName]=a.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,f):a:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,f)}function T(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function A(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function B(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(T,this),this.reset(!0)}function L(t){if(t||""===t){var n=t[a];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var r=-1,o=function n(){for(;++r<t.length;)if(i.call(t,r))return n.value=t[r],n.done=!1,n;return n.value=e,n.done=!0,n};return o.next=o}}throw new TypeError(Ne(t)+" is not iterable")}return g.prototype=b,r(k,"constructor",{value:b,configurable:!0}),r(b,"constructor",{value:g,configurable:!0}),g.displayName=c(b,l,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===g||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,b):(e.__proto__=b,c(e,l,"GeneratorFunction")),e.prototype=Object.create(k),e},t.awrap=function(e){return{__await:e}},P(M.prototype),c(M.prototype,s,(function(){return this})),t.AsyncIterator=M,t.async=function(e,n,i,r,o){void 0===o&&(o=Promise);var a=new M(h(e,n,i,r),o);return t.isGeneratorFunction(n)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},P(k),c(k,l,"Generator"),c(k,a,(function(){return this})),c(k,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var i in t)n.push(i);return n.reverse(),function e(){for(;n.length;){var i=n.pop();if(i in t)return e.value=i,e.done=!1,e}return e.done=!0,e}},t.values=L,B.prototype={constructor:B,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(A),!t)for(var n in this)"t"===n.charAt(0)&&i.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function r(i,r){return s.type="throw",s.arg=t,n.next=i,r&&(n.method="next",n.arg=e),!!r}for(var o=this.tryEntries.length-1;o>=0;--o){var a=this.tryEntries[o],s=a.completion;if("root"===a.tryLoc)return r("end");if(a.tryLoc<=this.prev){var l=i.call(a,"catchLoc"),c=i.call(a,"finallyLoc");if(l&&c){if(this.prev<a.catchLoc)return r(a.catchLoc,!0);if(this.prev<a.finallyLoc)return r(a.finallyLoc)}else if(l){if(this.prev<a.catchLoc)return r(a.catchLoc,!0)}else{if(!c)throw Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return r(a.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc<=this.prev&&i.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var o=r;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var a=o?o.completion:{};return a.type=e,a.arg=t,o?(this.method="next",this.next=o.finallyLoc,f):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),f},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),A(n),f}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var i=n.completion;if("throw"===i.type){var r=i.arg;A(n)}return r}}throw Error("illegal catch attempt")},delegateYield:function(t,n,i){return this.delegate={iterator:L(t),resultName:n,nextLoc:i},"next"===this.method&&(this.arg=e),f}},t}function Ye(e,t,n,i,r,o,a){try{var s=e[o](a),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(i,r)}function Qe(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,$e(i.key),i)}}function $e(e){var t=function(e){if("object"!=Ne(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=Ne(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==Ne(t)?t:t+""}var Xe=[{name:"shoot",path:"assets/sounds/shoot.mp3"},{name:"pickup",path:"assets/sounds/pickup.mp3"},{name:"damage",path:"assets/sounds/damage.mp3"},{name:"main_track_1",path:"assets/sounds/vibe_Jam.mp3"},{name:"main_track_2",path:"assets/sounds/Buzz_Revolution.mp3"}],Ke=["main_track_1","main_track_2"],Ze=function(){return e=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.assetManager=new d(this),this.soundManager=new x,this.loadingScreen=new s(this),this.setupRenderer(),this.setupScene(),this.setupCamera(),this.fpsCounter=new I({updateInterval:50,samples:20}),this.ui=new A(this),this.gameState="loading",this.currentEnvironment="exterior",this.isPointerLockPending=!1,this.inCombat=!1,this.playerHealth=100,this.isMobile=!1,this.initializeGame(),this.setupEventListeners(),this.animate(),this.mobileManager=new _e(this),this.portalSystem=new qe(this)},t=[{key:"initializeGame",value:(n=We().mark((function e(){var t=this;return We().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.assetManager.init((function(e){t.loadingScreen&&t.loadingScreen.updateProgress(e.progress);var n=document.getElementById("loading-progress");n&&(n.style.width="".concat(e.progress,"%"))}));case 3:return this.player=new F(this),this.collisionSystem=new Te(this),this.treeHive=new M(this),this.treeHive.treeGroup&&(this.treeHive.treeGroup.visible=!1),this.skybox=new De(this),this.skybox.skyboxMesh&&(this.skybox.skyboxMesh.visible=!1),this.scene.background=new i.Q1f(0),this.particlePool=new ze({scene:this.scene}),this.combatArena=new ve(this),this.combatArena.arenaGroup.visible=!1,e.next=15,this.soundManager.loadSounds(Xe);case 15:this.soundManager.playMusic(Ke),e.next=22;break;case 18:e.prev=18,e.t0=e.catch(0),console.error("Error initializing game:",e.t0),this.loadingScreen;case 22:case"end":return e.stop()}}),e,this,[[0,18]])})),r=function(){var e=this,t=arguments;return new Promise((function(i,r){var o=n.apply(e,t);function a(e){Ye(o,i,r,a,s,"next",e)}function s(e){Ye(o,i,r,a,s,"throw",e)}a(void 0)}))},function(){return r.apply(this,arguments)})},{key:"setupRenderer",value:function(){this.renderer=new i.JeP({antialias:!0}),this.renderer.setSize(window.innerWidth,window.innerHeight);var e=this.isMobile?1:1.5;this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,e)),this.isMobile&&(this.renderer.antialias=!1),document.body.appendChild(this.renderer.domElement)}},{key:"setupScene",value:function(){this.scene=new i.Z58}},{key:"setupCamera",value:function(){this.camera=new i.ubm(75,window.innerWidth/window.innerHeight,1,this.isMobile?5e3:1e4),this.camera.position.set(0,5,15),this.cameraTarget=new i.Pq0(0,0,0),this.camera.lookAt(this.cameraTarget)}},{key:"setupEventListeners",value:function(){var e=this;window.addEventListener("resize",(function(){return e.onWindowResize()})),window.addEventListener("keydown",(function(t){return e.handleKeyDown(t)})),window.addEventListener("keyup",(function(t){return e.handleKeyUp(t)})),document.addEventListener("mousemove",(function(t){return e.handleMouseMove(t)})),document.addEventListener("mousedown",(function(t){"playing"===e.gameState&&e.isPointerLocked&&"interior"===e.currentEnvironment&&e.inCombat&&e.playerShoot()})),document.addEventListener("mouseup",(function(){e.player&&(e.player.moveUp=!1)})),this.renderer.domElement.addEventListener("click",(function(){"playing"!==e.gameState||e.isPointerLocked||e.lockPointer()})),document.addEventListener("pointerlockchange",(function(){return e.handlePointerLockChange()})),document.addEventListener("pointerlockerror",(function(){return console.error("Pointer lock error")})),this.setupMobileControls()}},{key:"setupMobileControls",value:function(){}},{key:"checkMobileDevice",value:function(){return this.isMobile=!!this.mobileManager&&this.mobileManager.isMobile,this.isMobile}},{key:"handleMobileRotation",value:function(e,t){this.mobileManager&&this.mobileManager.applyLookToPlayer(e,t)}},{key:"lockPointer",value:function(){if(!this.isPointerLockPending&&!this.isPointerLocked)try{this.isPointerLockPending=!0,this.renderer.domElement.requestPointerLock=this.renderer.domElement.requestPointerLock||this.renderer.domElement.mozRequestPointerLock||this.renderer.domElement.webkitRequestPointerLock,this.renderer.domElement.requestPointerLock()}catch(e){console.log("Pointer lock request failed:",e),this.isPointerLockPending=!1}}},{key:"handlePointerLockChange",value:function(){this.isPointerLocked=document.pointerLockElement===this.renderer.domElement||document.mozPointerLockElement===this.renderer.domElement||document.webkitPointerLockElement===this.renderer.domElement,this.isPointerLockPending=!1,this.isPointerLocked||"playing"!==this.gameState?this.hideClickToPlayOverlay():this.showClickToPlayOverlay()}},{key:"showClickToPlayOverlay",value:function(){var e=this;this.clickToPlayOverlay?this.clickToPlayOverlay.style.display="flex":(this.clickToPlayOverlay=document.createElement("div"),this.clickToPlayOverlay.style.position="absolute",this.clickToPlayOverlay.style.top="0",this.clickToPlayOverlay.style.left="0",this.clickToPlayOverlay.style.width="100%",this.clickToPlayOverlay.style.height="100%",this.clickToPlayOverlay.style.display="flex",this.clickToPlayOverlay.style.alignItems="center",this.clickToPlayOverlay.style.justifyContent="center",this.clickToPlayOverlay.style.backgroundColor="rgba(0, 0, 0, 0.4)",this.clickToPlayOverlay.style.color="white",this.clickToPlayOverlay.style.fontSize="24px",this.clickToPlayOverlay.style.cursor="pointer",this.clickToPlayOverlay.style.zIndex="100",this.clickToPlayOverlay.innerHTML="Click to control bee",this.clickToPlayOverlay.addEventListener("click",(function(){e.lockPointer(),e.hideClickToPlayOverlay()})),document.body.appendChild(this.clickToPlayOverlay))}},{key:"hideClickToPlayOverlay",value:function(){this.clickToPlayOverlay&&(this.clickToPlayOverlay.style.display="none")}},{key:"handleMouseMove",value:function(e){if("playing"===this.gameState)if(this.isPointerLocked){var t=e.movementX||e.mozMovementX||e.webkitMovementX||0,n=e.movementY||e.mozMovementY||e.webkitMovementY||0;this.lastMouseX=t,this.lastMouseY=n,this.player.handleMouseMove(t,n)}else{var i=window.innerWidth/2,r=window.innerHeight/2,o=.05*(e.clientX-i),a=.05*(e.clientY-r);this.player.handleMouseMove(o,a)}}},{key:"handleKeyDown",value:function(e){if("menu"!==this.gameState&&"gameover"!==this.gameState&&"victory"!==this.gameState)switch(e.code){case"KeyW":case"ArrowUp":this.player.accelerate=!0;break;case"KeyS":case"ArrowDown":this.player.brake=!0;break;case"KeyA":case"ArrowLeft":this.player.moveLeft=!0;break;case"KeyD":case"ArrowRight":this.player.moveRight=!0;break;case"Space":this.player.boost();break;case"KeyP":"playing"!==this.gameState&&"paused"!==this.gameState||(this.escapeKeyPressed=!0,this.togglePause())}else"Space"!==e.code&&"Enter"!==e.code||this.startGame()}},{key:"handleKeyUp",value:function(e){switch(e.code){case"KeyW":case"ArrowUp":this.player.accelerate=!1;break;case"KeyS":case"ArrowDown":this.player.brake=!1;break;case"KeyA":case"ArrowLeft":this.player.moveLeft=!1;break;case"KeyD":case"ArrowRight":this.player.moveRight=!1}}},{key:"startGame",value:function(){var e=this,t="true"===new URLSearchParams(window.location.search).get("portal"),n="gameover"===this.gameState&&"interior"===this.currentEnvironment;this.soundManager&&this.soundManager.resumeContext(),this.player&&(this.player.position.set(0,50,n?30:50),this.player.velocity.set(0,0,0)),this.resetGameElements(n),this.gameState="playing",this.startTime=performance.now(),this.lastFrameTime=performance.now(),this.elapsedTime=0,this.ui.updateGameState(this.gameState),t||this.lockPointer(),this.mobileManager&&(this.mobileManager.isMobile||this.forceMobileControls?this.mobileManager.showControls():this.mobileManager.hideControls()),t||n?(this.treeHive.treeGroup.visible=!1,this.currentEnvironment="interior",this.combatArena&&(this.combatArena.arenaGroup.visible=!0,setTimeout((function(){console.log("Re-initializing combat arena..."),e.combatArena.initializeCombat(),e.inCombat=!0,e.player&&(e.player.position.set(0,50,30),e.player.velocity.set(0,0,0),e.player.updateCamera())}),100))):(this.treeHive&&(this.treeHive.treeGroup.visible=!0),this.currentEnvironment="exterior",this.inCombat=!1,this.combatArena&&(this.combatArena.arenaGroup.visible=!1)),this.skybox&&(this.skybox.currentZone=this.currentEnvironment,"interior"===this.currentEnvironment&&this.skybox.interiorHive&&(this.scene.background=this.skybox.interiorHive)),this.touchRotationArea&&(this.touchRotationArea.style.display="block")}},{key:"resetGameElements",value:function(){var e="gameover"===this.gameState&&"interior"===this.currentEnvironment?this.currentEnvironment:"exterior";this.maze&&this.maze.reset(),this.combatArena&&this.combatArena.reset(),this.player&&this.player.reset(),this.combatArena&&this.combatArena.enemyManager&&this.combatArena.enemyManager.reset(),this.collisionSystem&&(this.collisionSystem.reset(),this.collidersRegistered=!1,this.mazeCollidersRegistered=!1),this.currentEnvironment=e,this.inCombat="interior"===e,this.playerHealth=100}},{key:"switchEnvironment",value:function(e){var t=this;if(this.currentEnvironment!==e){if(this.player&&this.player.switchMovementProfile(e),"interior"===e)return this.currentEnvironment="interior",this.treeHive&&(this.treeHive.treeGroup.visible=!1,this.treeHive.backgroundPlane&&(this.treeHive.backgroundPlane.visible=!1)),this.skybox&&(this.skybox.currentZone="interior",this.skybox.interiorHive?(this.scene.background=this.skybox.interiorHive,this.scene.environment=null):this.scene.background=new i.Q1f(13016173)),this.renderer&&(this.renderer.autoClear=!0,this.renderer.sortObjects=!0),this.combatArena&&(this.combatArena.arenaGroup.visible=!0,setTimeout((function(){t.combatArena.initializeCombat(),t.inCombat=!0}),1e3)),this.portalSystem&&"function"==typeof this.portalSystem.updatePortalVisibility&&this.portalSystem.updatePortalVisibility(),void(this.player&&(this.player.position.set(0,50,30),this.player.velocity.set(0,0,0)));"exterior"===e&&(this.currentEnvironment="exterior",this.portalSystem&&"function"==typeof this.portalSystem.updatePortalVisibility&&this.portalSystem.updatePortalVisibility())}}},{key:"playerShoot",value:function(){if(this.inCombat&&"interior"===this.currentEnvironment){var e=this.player.position.clone(),t=new i.Pq0(0,0,-1).applyQuaternion(this.player.currentRotation),n=e.clone().add(t.clone().multiplyScalar(1.5));this.combatArena&&this.combatArena.bulletManager&&(this.combatArena.bulletManager.createBullet(n,t,!0),this.soundManager.playSound("shoot"))}}},{key:"handlePlayerHit",value:function(){if(this.playerHealth-=10,this.soundManager.playSound("damage"),this.particlePool&&this.player){var e=this.isMobile?8:15;this.particlePool.createEffect({type:"spark",position:this.player.position.clone(),count:e,spread:1,velocity:.3,maxLifetime:30,acceleration:new i.Pq0(0,0,0),onUpdate:function(e){e.material&&e.material.color.setRGB(1,.3,.3),e.material.opacity-=.05}})}this.playerHealth<=0&&this.endGame(!1)}},{key:"endGame",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.gameState=e?"victory":"gameover",this.ui.updateGameState(this.gameState,this.elapsedTime),document.exitPointerLock&&document.exitPointerLock(),this.touchRotationArea&&(this.touchRotationArea.style.display="none"),this.mobileManager&&this.mobileManager.hideControls()}},{key:"togglePause",value:function(){if("playing"===this.gameState){if(this.gameState="paused",this.ui.updateGameState(this.gameState),this.mobileManager&&this.mobileManager.isMobile)try{"function"==typeof this.mobileManager.showSensitivityControls&&this.mobileManager.showSensitivityControls(!0)}catch(e){console.warn("Error showing mobile sensitivity controls:",e)}}else if("paused"===this.gameState){if(this.gameState="playing",this.mobileManager&&this.mobileManager.isMobile)try{"function"==typeof this.mobileManager.showSensitivityControls&&this.mobileManager.showSensitivityControls(!1)}catch(e){console.warn("Error hiding mobile sensitivity controls:",e)}this.ui.updateGameState(this.gameState)}}},{key:"onWindowResize",value:function(){if(this.renderer.setSize(window.innerWidth,window.innerHeight),this.mobileManager){this.isMobile=this.mobileManager.isMobile;var e=this.isMobile?1:1.5;this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,e)),"function"==typeof this.mobileManager.handleResize&&this.mobileManager.handleResize()}this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix()}},{key:"createHoneyParticles",value:function(){var e=this.isMobile?.03:.1;if(!(Math.random()>e)&&this.particlePool){var t=this.isMobile?0:1;if(0===t)return;var n=new i.Pq0(6*(Math.random()-.5),6*(Math.random()-.5),15-5*Math.random());this.particlePool.createHoneyDrip(n,{count:t,velocity:.03,lifetime:100+Math.floor(50*Math.random())})}}},{key:"startCombat",value:function(){this.inCombat=!1,this.combatArena&&(this.combatArena.initializeCombat(),this.combatArena.arenaGroup.visible=!0,this.maze&&(this.maze.mazeGroup.visible=!1))}},{key:"checkEnvironmentCollisions",value:function(){"interior"===this.currentEnvironment&&this.inCombat&&this.combatArena&&this.collisionSystem&&this.collisionSystem.checkCollisions(this.player,this.player.radius)}},{key:"update",value:function(){if("playing"===this.gameState){var e=performance.now(),t=e-this.lastFrameTime;if(this.lastFrameTime=e,this.elapsedTime=(e-this.startTime)/1e3,this.portalSystem&&this.portalSystem.update(),this.player&&this.player.update(t),this.particlePool&&this.particlePool.update(),this.player&&this.player.position){var n=this.player.position.x,i=this.player.position.y,r=this.player.position.z,o=n*n+i*i+r*r;o<225&&"interior"!==this.currentEnvironment&&this.switchEnvironment("interior"),Math.sqrt(o)}"interior"===this.currentEnvironment&&(this.inCombat&&this.combatArena?this.combatArena.update(t):this.maze&&this.maze.update(t),this.skybox&&this.skybox.update(t)),this.checkEnvironmentCollisions(),this.treeHive&&this.treeHive.update()}}},{key:"animate",value:function(){var e=this;requestAnimationFrame((function(){return e.animate()}));var t=performance.now(),n=t-this.lastFrameTime;if(n>200)this.lastFrameTime=t;else{if(this.fpsCounter&&this.fpsCounter.update(),"menu"===this.gameState&&this.treeHive){if(this.treeHive.treeGroup.visible=!0,this.skybox&&this.skybox.skyboxMesh&&(this.skybox.skyboxMesh.visible=!1),this.treeHive.backgroundPlane){var i=this.camera.position.clone();this.treeHive.backgroundPlane.position.set(0,0,-500),this.treeHive.backgroundPlane.lookAt(i)}this.treeHive.backgroundTexture&&(this.treeHive.backgroundTexture.needsUpdate=!0)}"paused"!==this.gameState&&(this.update(n),"interior"===this.currentEnvironment&&this.renderer?this.renderer.sortObjects=!0:this.renderer&&(this.renderer.sortObjects=!1),this.renderer.render(this.scene,this.camera)),this.lastFrameTime=t}}}],t&&Qe(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,n,r}();const Je=Ze}}]);